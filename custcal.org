#+TODO: TODO | DONE
#+TODO: OPEN | CLOSED


* 经纪业务客户核算设计

** 总体要求

*** 客户范围
全体经纪业务客户，同一名客户A股、B股、融资融券、开放式基金、黄金、OTC、期权业务等需要统一核算。同一名客户是指同一个营业部号下的客户号相同（orgid,custid）。

*** 精确性要求
要求精准核算，每一笔流水需要确认清楚，计算准确。即按照业务发生的适用情形，分别计算出相关证券的股份增减、成本增减、净价损益、利息收入、各类税费以及融资利息和融券费用等各项科目，以及准确计量各项统计数据，比如累计成交数量、成交金额等；对于个别不能系统自动确认的业务流水，需要梳理清楚，通过设计机制来解决（不能牺牲精度），包括由运行人员手工确认后再做处理等。总之，每一笔流水处理要准确，不可草率处理。

*** 及时性要求
当晚产生核算结果，通过接口提供给CRM系统后，由外围系统调用对客户提供揭示。要求系统性能较好，能支持在30分钟内完成每天5百万流水的业务处理，以及5百万以上持仓的公允价值和预计利息的计提处理，以及后续数据校验核对和数据汇总、数据归档、磁盘备份等步骤。

*** 输出
客户资产情况，成交情况，交易特点，盈亏能力，贡献（含交易佣金、息差、融资融券息费等），税费支出、融资融券情况等进行全方位核算。


** 核算输入输出 						     :tables:

#+NAME: tab:核算输入输出
|----------+--------------+----------|
| 核算对象 | 数据库表     | 对象类型 |
|----------+--------------+----------|
| 业务流水 | logasset_hs  | 输入     |
| 持仓核算 | stkasset_hs  | 输出     |
| 资金核算 | fundasset_hs | 输出     |
|----------+--------------+----------|


*** 输入：业务流水表						    :columns:

#+NAME: tab:业务流水表字段定义
|----------+----------+----------------------+------------------------------------|
| 变量名称 | 变量类型 | 数据库字段           | 说明                               |
|----------+----------+----------------------+------------------------------------|
| 节点号   | 信息     | 业务流水.serverid    |                                    |
| 交收日期 | 信息     | 业务流水.bizdate     | 以交收日期为核算日期               |
| 交易日期 | 信息     | 业务流水.orderdate   |                                    |
| 委托序号 | 信息     | 业务流水.orderid     |                                    |
| 委托号   | 信息     | 业务流水.ordersno    |                                    |
| 交易序号 | 信息     | 业务流水.sno         | 业务流水标识                       |
| 关联序号 | 信息     | 业务流水.ref_sno     |                                    |
| 关联代码 | 信息     | 业务流水.ref_stkcode |                                    |
| 机构号   | 信息     | 业务流水.orgid       |                                    |
| 客户号   | 信息     | 业务流水.custid      |                                    |
| 资金账号 | 信息     | 业务流水.fundid      |                                    |
| 证券账号 | 信息     | 业务流水.secuid      |                                    |
| 货币类型 | 信息     | 业务流水.moneytype   | 0人民币、1港币、2美元              |
| 业务摘要 | 信息     | 业务流水.digestid    |                                    |
| 市场代码 | 信息     | 业务流水.market      | 0深A、1沪A、2深B 、3沪B            |
| 证券代码 | 信息     | 业务流水.stkcode     |                                    |
| 银行代码 | 信息     | 业务流水.bankcode    |                                    |
| 资金发生 | 信息     | 业务流水.fundeffect  |                                    |
| 资金余额 | 信息     | 业务流水.fundbal     |                                    |
| 股份发生 | 信息     | 业务流水.stkeffect   |                                    |
| 股份余额 | 信息     | 业务流水.stkbal      |                                    |
| 成交数量 | 信息     | 业务流水.matchqty    | 股份实际成交数量或者转托管等的数量 |
| 成交金额 | 信息     | 业务流水.matchamt    |                                    |
| 成交价格 | 信息     | 业务流水.matchprice  |                                    |
| 净手续费 | 信息     | 业务流水.fee_jsxf    | 说明 1)                            |
| 手续费   | 信息     | 业务流水.fee_sxf     | 说明 1)                            |
| 过户费   | 信息     | 业务流水.fee_ghf     | 说明 3)                            |
| 印花税   | 信息     | 业务流水.fee_yhs     | 说明 4)                            |
| 前台费   | 信息     | 业务流水.feefront    | 归入"其它费"                       |
| 操作方式 | 信息     | 业务流水.operway     |                                    |
| 买卖类别 | 信息     | 业务流水.bsflag      |                                    |
| 备注     | 信息     | 业务流水.remark      |                                    |
| 核算状态 | 信息     | 业务流水.sett_status |                                    |
| 核算备注 | 信息     | 业务流水.sett_remark |                                    |
|----------+----------+----------------------+------------------------------------|


说明  
1)  用户付出的手续费，减去交易所费用等，才是CSC收到的净手续费。手续费不含印花税、过户费、前台费。
3)  过户费是指委托买卖的股票、基金成交后买卖双为变更股权登记所支付的费用。
    - 这笔收入属于证券登记清算机构的收入。
    - 由CSC在同投资者清算交割时代为扣收。
4)  印花税：只对卖出方（或继承、赠与A股、B股股权的出让方）征收证券（股票）交易印花税。
    - 对买入方(受让方)不征税。
    - 税率为 1‰。

**** OPEN 外币处理
货币一般为人民币。如遇外币，原则是每种货币分开核算。如需加总（如计算总资产totalvalue时），则需按照汇率折成人民币处理。具体处理方式待定。

**** OPEN 证券账号secuid作用？
**** OPEN 业务摘要
有两个字段（busintype，digestid）都表示业务摘要？

**** OPEN 关联序号
有两个字段（ref_sno, relativesno）都表示关联序号？

**** OPEN creditid，creditflag，bsflag作用？

*** 输出：持仓核算表						    :columns:

输出表的字段分三类：
-  交易信息 :: 一般为非数值量，来自业务流水表等记录交易信息的字段。
-  会计科目 :: 能够用复式记账法进行核算的会计科目。资产 + 费用 = 负债 + 收益。
-  统计量 :: 对会计科目的进一步加工（汇总、差分等）或对交易细节的记录。

变动类字段，在每天的初始化阶段会清零。所以核算过程中只要和其对应的加总字段一致变化即可。

持仓头寸归集标准为：
  - 节点号、营业部号、客户号、资金账号、市场、证券代码、流通类型。
  - 凡以上七个字段相同的操作，影响同一个证券持仓头寸。

#+NAME: tab:持仓核算表字段定义
|------------------+------+------------------------+------------------------------------|
| 变量名称         | 类型 | 数据库字段             | 说明                               |
|------------------+------+------------------------+------------------------------------|
| 节点号           | 信息 | 持仓核算.serverid      | 节点A：1-3，B股：7，融资融券：8    |
| 营业部号         | 信息 | 持仓核算.orgid         | 对应业务流水相同字段               |
| 客户号           | 信息 | 持仓核算.custid        | 对应业务流水相同字段               |
| 资金帐号         | 信息 | 持仓核算.fundid        | 对应业务流水相同字段               |
| 市场             | 信息 | 持仓核算.market        | 0,1,2,3,J,6,8                      |
| 证券代码         | 信息 | 持仓核算.stkcode       | 对应业务流水相同字段               |
| 市场价格         | 信息 | 持仓核算.stkprice      | 市场数据表的收盘价                 |
| 流通类型         | 信息 | 持仓核算.ltlx          | 说明 1)                            |
| 计提日期         | 信息 | 持仓核算.jtdate        | 说明 2)                            |
| 公允日期         | 信息 | 持仓核算.gydate        | ？                                 |
| 备注             | 信息 | 持仓核算.remark        | 内容不做限制                       |
|------------------+------+------------------------+------------------------------------|
| 库存成本         | 借方 | 持仓核算.stkcost       | 不含费用                           |
| 浮动盈亏         | 贷方 | 持仓核算.gyvalue       | 等于：市值金额 - 库存成本          |
| 投资收益         | 贷方 | 持仓核算.syvalue       | 核算买卖价差损益（平均成本法）     |
| 利息收入         | 贷方 | 持仓核算.lxsr          | 说明 11)                           |
| 融资利息         | 贷方 | 持仓核算.rzlx          |                                    |
| 融券利息         | 贷方 | 持仓核算.rqlx          |                                    |
| 净手续费         | 借方 | 持仓核算.jsxf          | 即券商佣金                         |
| 印花税           | 借方 | 持仓核算.yhs           |                                    |
| 过户费           | 借方 | 持仓核算.ghf           |                                    |
| 利息税           | 借方 | 持仓核算.lxs           | ？                                 |
| 其它费           | 借方 | 持仓核算.qtfee         |                                    |
|------------------+------+------------------------+------------------------------------|
| 买入数量         | 统计 | 持仓核算.stkbuyqty     | 二级市场买卖交易，统计客户交易量用 |
| 买入金额         | 统计 | 持仓核算.stkbuyamt     |                                    |
| 卖出数量         | 统计 | 持仓核算.stksaleqty    | 二级市场买卖交易，统计客户交易量用 |
| 卖出金额         | 统计 | 持仓核算.stksaleamt    |                                    |
| 其它买入金额     | 统计 | 持仓核算.stkbuyamt_ex  | 说明 3)                            |
| 其它卖出金额     | 统计 | 持仓核算.stksaleamt_ex | 说明 3)                            |
| 转入数量         | 统计 | 持仓核算.stkztgrqty    | 说明 4)                            |
| 转入金额         | 统计 | 持仓核算.stkztgramt    | 说明 4)                            |
| 转出数量         | 统计 | 持仓核算.stkztgcqty    | 说明 4)                            |
| 转出金额         | 统计 | 持仓核算.stkztgcamt    | 说明 4)                            |
| 质押数量         | 统计 | 持仓核算.stkpledge     | 说明 5)                            |
| 借入数量         | 统计 | 持仓核算.stkdebt       | 说明 6)   ?                        |
| 借出数量         | 统计 | 持仓核算.stkloan       | 说明 6)                            |
| 外部转托金额     | 统计 | 持仓核算.stkadjust     | 说明 7)                            |
| 红股数量         | 统计 | 持仓核算.stkhgqty      | 红股价格视为零                     |
| 红利金额         | 统计 | 持仓核算.stkhlamt      |                                    |
| 配股数量         | 统计 | 持仓核算.stkpgqty      | 视为以配股价格购入                 |
| 配股金额         | 统计 | 持仓核算.stkpgamt      |                                    |
| 库存数量         | 统计 | 持仓核算.stkqty        | 说明 8)                            |
| 调整数量         | 统计 | 持仓核算.stkqty_tz     | 说明 9)                            |
| 调整金额         | 统计 | 持仓核算.stkqty_tzje   | 说明 9)                            |
| 债券票面利息     | 统计 | 持仓核算.bondintr      | 说明 10)                           |
| 预计利息         | 统计 | 持仓核算.aiamount      | 说明 10)                           |
| 利息成本         | 统计 | 持仓核算.aicost        | 说明 10)                           |
| 利息计提         | 统计 | 持仓核算.lxjt          | 说明 10)                           |
| 回购利息         | 统计 | 持仓核算.hglx          |                                    |
| 市值金额         | 统计 | 持仓核算.mktvalue      | 等于：市场价格 * 库存数量          |
| 费用             | 统计 | 持仓核算.fee           | 说明 12)                           |
| 库存数量变动     | 统计 | 持仓核算.stkqty_ch     | 等于：差分 库存数量                |
| 库存成本变动     | 统计 | 持仓核算.stkcost_ch    | 等于：差分 库存成本                |
| 外部转托金额变动 | 统计 | 持仓核算.stkadjust_ch  | 等于：差分 外部转托金额            |
| 投资收益变动     | 统计 | 持仓核算.syvalue_ch    | 等于：差分 投资收益                |
| 浮动盈亏变动     | 统计 | 持仓核算.gyvalue_ch    | 等于：差分 浮动盈亏                |
| 利息收入变动     | 统计 | 持仓核算.lxsr_ch       | 等于：差分 利息收入                |
| 融资利息变动     | 统计 | 持仓核算.rzlx_ch       | 等于：差分 融资利息                |
| 融券利息变动     | 统计 | 持仓核算.rqlx_ch       | 等于：差分 融券利息                |
| 费用变动         | 统计 | 持仓核算.fee_ch        | 等于：差分 费用                    |
| 利息成本变动     | 统计 | 持仓核算.aicost_ch     | 等于：差分 利息成本                |
| 利息计提变动     | 统计 | 持仓核算.lxjt_ch       | 等于：差分 利息计提                |
| 回购利息变动     | 统计 | 持仓核算.hglx_ch       | 等于：差分 回购利息                |
| 净手续费变动     | 统计 | 持仓核算.jsxf_ch       | 等于：差分 净手续费                |
| 印花税变动       | 统计 | 持仓核算.yhs_ch        | 等于：差分 印花税                  |
| 过户费变动       | 统计 | 持仓核算.ghf_ch        | 等于：差分 过户费                  |
| 其它费变动       | 统计 | 持仓核算.qtfee_ch      | 等于：差分 其它费                  |
| 利息税变动       | 统计 | 持仓核算.lxs_ch        | 等于：差分 利息税                  |
|------------------+------+------------------------+------------------------------------|

说明
1)  流通类型相当于证券代码的补充。包括：00流通股 01限售流通 03申购状态 06融资回购 07融券回购 80多仓 81空仓。
    - 正常情况下一般都是00流通股，涉及到新股申购、未上市股份、融资融券、期货期权时才不为00。
2)  计提的目的是更新市场价值（MTM）和利息积数（accrual），是每天的一次操作。
    - 在核算完成后由外部单独步骤“公允与利息处理”触发。
3)  不参与交易量统计,非交易量金额，如ETF申赎现金替代、转债转股资金、行权资金等。
4)  是指在公司内部不同资产形式的转换，区别从外部转入转出的资产。
    - 含转托管入或出、ETF申赎转入或出、转债转股入或出、合并拆分入或出、ETF认购入或出、其他转换类入或出等。
    - 转入转出价格一般指定为当日收盘价格。不影响资金发生。 
5)  质押的证券不影响成本。相当于把证券“冻结”，因此会限制可出售的证券数量。
6)  借出证券不影响成本。但会减少允许出售的份数。
7)  外部转托管金额记录非我公司资产之间的转入转出。此项引起的资产增加或减少，视同基金的申购或退出。
    - 参考价格为当日收盘价。
8)  库存数量等于：(买入数量-卖出数量)+(转入数量-转出数量)+红股数量+配股数量-还本数量（未列出）
9)  调整数量和调整金额可正可负。用于分红到帐和除权除息不同步时校正市值。
10) 与债券利息有关各统计量的关系：
    - 预计利息是截至当天属于客户，但还未交收的利息。
    - 预计利息 = 库存数量 * 债券票面利息 = 利息成本 + 利息计提
    - 利息成本是所有债券交易全价与净价之差部分的累积（前手息）。
    - 债券卖出时，利息成本按卖出数量与库存数量的比例计减。
    - 利息计提是由于客户持有债券挣得的利息部分。
    - 利息计提 = 预计利息 - 利息成本
    - 债券票面利息 = 预计利息 / 库存数量
11) 利息收入核算已经交收的股息或者债券利息。
    - 判断是股息还是债券利息，可由证券代码进行区分。
    - 卖出债券时，按照卖出利息金额-利息成本记增。（合理？）
12)  费用汇总所有税费和手续费，等于：净手续费 + 印花税 + 过户费 + 利息税 + 其它费。



**** OPEN 利息税计算？

**** OPEN 公允日期
和“计提日期”的关系？gydate = jtdate?

**** OPEN 债券票面利息
债券票面利息bondintr和利息收入lxsr有什么区别？债券每日计提利息的金额在哪里保存？
债券卖出时利息收入的计算按利息成本平均，是否合理？

**** OPEN 借入的证券，如何核算成本？
比如出售借入的证券，按什么成本核算损益？
涉及借入证券的业务是否为：融券借入（553003）？

**** OPEN 转托管
从logasset记录来看，无论内部还是外部转托管都不涉及资金账户（logasset.fundeffect=0）。即转托管只是证券份额的转移。

外部转托管的digestid：
- 转托管入（220015）（目前无记录）
- 转托管出（221014）        

转托管出（221014），logasset.remark又有两种情况。这两种情况分别对应什么业务实质？
- 转托管，matchprice,matchamount = 0
- 转托管出，matchprice,matchamount > 0

托管转出转入后由于证券份数发生了变化，必定影响成本。问题是成本应以什么标准增减（matchamount？但是很多情况下没有matchamount。是否应使用目前单位成本？，这样不会影响单位成本）。

由于不涉及资金科目，需要有一个“转托管成本”科目，以和“证券成本”科目搭配，否则借贷不平了。这个科目是否就是stkadjust的作用？

内部转托管的digestid：
- 内部转托管出（150028）
- 股份认领（150030）

logasset中，只有stkeffect不为零。这里仍然有确定成本变化量的问题。


如何影响份数？用当日收盘价？

转托管只有深市有，沪市是没有的。

*** 输出：资金资产核算表					    :columns:

资金头寸归集标准为：
  - 节点号、营业部号、客户号、银行代码、资金账号、货币类型。
  - 凡以上五个字段相同的操作，影响同一个资金头寸。

#+NAME: tab:资金资产表字段定义
|------------------+------+------------------------+-----------------------------------------------|
| 变量名称         | 类型 | 数据库字段             | 说明                                          |
|------------------+------+------------------------+-----------------------------------------------|
| 节点号           | 信息 | 资金核算.serverid      | 对应业务流水相同字段                          |
| 营业部号         | 信息 | 资金核算.orgid         | 对应业务流水相同字段                          |
| 客户号           | 信息 | 资金核算.custid        | 对应业务流水相同字段                          |
| 资金帐号         | 信息 | 资金核算.fundid        | 对应业务流水相同字段                          |
| 货币类型         | 信息 | 资金核算.moneytype     | 对应业务流水相同字段                          |
| 银行代码         | 信息 | 资金核算.bankcode      | 开户行标识                                    |
| 统计日期         | 信息 | 资金核算.tjdate        |                                               |
| 备注             | 信息 | 资金核算.remark        | 不限制内容                                    |
|------------------+------+------------------------+-----------------------------------------------|
| 本日余额         | 借方 | 资金核算.fundbal       | 借出、借入的金额会影响余额                    |
| 在途未收         | 借方 | 资金核算.funduncome    | 应收账款                                      |
| 在途未付         | 贷方 | 资金核算.fundunpay     | 应付账款                                      |
| 借出金额         | 借方 | 资金核算.fundloan      | 拆借资产                                      |
| 借入金额         | 贷方 | 资金核算.funddebt      | 拆借负债                                      |
| 利息积数         | 贷方 | 资金核算.fundintr      | 未发放的利息收入 说明 1)                      |
| 累计结息         | 贷方 | 资金核算.fundaward     | 已经发放的利息收入 说明 1)                    |
|------------------+------+------------------------+-----------------------------------------------|
| 存款金额         | 统计 | 资金核算.fundsave      |                                               |
| 取款金额         | 统计 | 资金核算.fundunsave    |                                               |
| 外部资产增减     | 统计 | 资金核算.fundadjust    | 说明 2)                                       |
| 上日余额         | 统计 | 资金核算.fundlastbal   |                                               |
| 本日余额变动     | 统计 | 资金核算.fundbal_ch    | 等于：差分 本日余额                           |
| 存款金额变动     | 统计 | 资金核算.fundsave_ch   | 等于：差分 存款金额                           |
| 取款金额变动     | 统计 | 资金核算.fundunsave_ch | 等于：差分 取款金额                           |
| 借出金额变动     | 统计 | 资金核算.fundloan_ch   | 等于：差分 借出金额                           |
| 借入金额变动     | 统计 | 资金核算.funddebt_ch   | 等于：差分 借入金额                           |
| 在途未收变动     | 统计 | 资金核算.funduncome_ch | 等于：差分 在途未收                           |
| 在途未付变动     | 统计 | 资金核算.fundunpay_ch  | 等于：差分 在途未付                           |
| 外部资产增减变动 | 统计 | 资金核算.fundadjust_ch | 等于：差分 外部资产增减                       |
| 利息积数变动     | 统计 | 资金核算.fundintr_ch   | 等于：差分 利息基数                           |
| 累计结息变动     | 统计 | 资金核算.fundaward_ch  | 等于：差分 累计结息                           |
| 总资产           | 统计 | 资金核算.totalvalue    | 说明 3)                                       |
| 单位净值         | 统计 | 资金核算.nav           | 说明 4)                                       |
| 总市值           | 统计 | 资金核算.mktvalue      | 等于：持仓核算表.市值金额，对所有证券代码求和 |
| 总份额           | 统计 | 资金核算.totalfe       | 说明 5)                                       |
|------------------+------+------------------------+-----------------------------------------------|


说明
1) 客户资金按活期存款计息，每季度发放。
    - 发放的总额就是累计结息。
    - 利息积数记录在发放利息之前已经累积的利息金额。类似于利息计提。
2)  包括资金转入转出或者外部转托管，影响折算份额的计算。
3)  总资产记录客户的净资产（资产－负债），包含客户持有的所有证券和现金。
    - 等于：总市值 + 本日余额 + 应收帐款 + 借出金额 - 借入金额
4)  单位净值等于：总资产/总份额，年初初始化为1，根据净值增减评判盈利能力。
5)  年初初始化,后续根据存取款按照当日单位净值折算成申购或者退出份额。  


**** OPEN 关于客户盈利能力评价
为合理评价客户盈利能力，需处理由于资本金频繁增减带来的利润。一个想法是
把客户按照一只基金对待。相关的字段是：

- 外部转托金额：持仓核算.stkadjust  
- 外部资产增减：资金核算.fundadjust
- 外部资产增减变动：资金核算.fundadjust_ch
- 总资产：资金核算.totalvalue
- 单位净值：资金核算.nav
- 总市值：资金核算.mktvalue
- 总份额：资金核算.totalfe

目前尚没有想清楚具体处理逻辑，以上字段暂不参加核算。

**** OPEN 累计结息 fundaward

建议增加“应收利息”科目，这样对资金活期利息的处理更加完整：

|----------------------------+----------+----------+--------------|
| 日期                       | 借方     | 贷方     | 金额         |
|----------------------------+----------+----------+--------------|
| 每日计提                   | 应收利息 | 利息积数 | 每日计提金额 |
| 结息日：入资金余额         | 资金余额 | 应收利息 | 结息金额     |
| 结息日：利息积数转累计结息 | 利息积数 | 累计结息 | 结息金额     |
|----------------------------+----------+----------+--------------|

**** OPEN 外部资产增减
fundasset_hs.fundadjust = stkasset_hs.stkadjust ?
目前不参加核算？



** 处理逻辑

*** 动作类型

#+NAME: tab:动作类型定义
|----------+----------+---------------------------------------------------------------|
| 动作类型 | 动作代码 | 说明                                                          |
|----------+----------+---------------------------------------------------------------|
| 交易买入 | 0B       | 买卖交易，一般会实际产生手续费                                |
| 交易卖出 | 0S       |                                                               |
| 内部转入 | ZR       | 资产不同形式资产的转换，比如ETF股票换基金，可转债转换为股票等 |
| 内部转出 | ZC       |                                                               |
| 外部转入 | WR       | 资产向我公司之外转出或者从外部转入进来                        |
| 外部转出 | WC       |                                                               |
| 红股红利 | HG       |                                                               |
| 股票配股 | PG       |                                                               |
| 质押入库 | ZYR      |                                                               |
| 质押出库 | ZYC      |                                                               |
| 证券融入 | RR       |                                                               |
| 证券融出 | RC       |                                                               |
| 基金申购 | EB       |                                                               |
| 基金赎回 | ES       |                                                               |
|----------+----------+---------------------------------------------------------------|


*** 公共过程参数说明

nb_Cust_Stkasset_Commit

#+NAME: tab:公共过程参数定义
|--------------+--------------------------------------------------------|
| 参数名称     | 说明                                                   |
|--------------+--------------------------------------------------------|
| @action      | 动作类型                                               |
| @matchqty    | 成交数量                                               |
| @matchamt    | 成交金额                                               |
| @matchamt_ex | 成交金额扩展                                           |
| @aiamount    | 债券票面金额，债券成交金额+债券票面金额=实际发生金额。 |
| @fundeffect  | 资金发生数，指实际资金发生数                           |
| @stkeffect   | 股份变动，股份实际变动数量，区别正负号                 |
| @stkcost_ch  | 成本金额，买入记增，卖出按实际数量摊销后记减           |
| @syvalue_ch  | 投资收益，卖出或划出时，按照卖出金额减去摊销成本记增   |
| @aicost_ch   | 利息成本，债券买入记增，卖出按实际数量摊销后记减       |
| @lxsr_ch     | 利息收入                                               |
| @fee         |                                                        |
| @jsxf        | 券商佣金(净手续费)                                     |
| @yhs         | 印花税                                                 |
| @ghf         | 过户费                                                 |
| @qtfee       | 其他费用                                               |
| @lxs         | 利息税                                                 |
|--------------+--------------------------------------------------------|


说明
- 成交金额扩展，不对应真实资金发生，一般指证券替换类业务证券市值折算出的金额。
  - 例如ETF申购赎回或债券转股，证券转托管折算的金额，此字段用于统计金额，永远为正数。
- 利息收入，债券卖出或兑付兑息火划出时，按照卖出利息金额减去摊销利息成本记增。

** 业务核算处理

*** 交易买入
**** 证券买入（220000） 					       
- 成交金额影响成本
- 不影响投资收益
- 费用处理：先把总费用（手续费）计入其它费用，再从其它费用中扣除过户费和券商佣金（净手续费）


| 借方     | 贷方     | 金额     |
|----------+----------+----------|
| 库存成本 | 资金余额 | 成交金额 |
| 其它费   | 资金余额 | 手续费   |
| 过户费   | 其它费   | 过户费   |
| 净手续费 | 其它费   | 净手续费 |

- 库存成本 += 成交金额
- 资金余额 -= 成交金额 + 手续费
- 过户费   += 过户费
- 净手续费 += 净手续费
- 其他费   += 手续费 - 过户费 - 净手续费

- 买入数量 += 成交数量
- 买入金额 += 成交金额

| action      | 0B                                  |
| matchqty    | 成交数量                            |
| matchamt    | 成交金额                            |
| matchamt_ex | 0                                   |
| aiamount    | 0                                   |
| fundeffect  | - 成交金额 - 手续费                 |
| stkeffect   | 成交数量                            |
| stkcost_ch  | 成交金额                            |
| syvalue_ch  | 0                                   |
| aicost_ch   | 0                                   |
| lxsr_ch     | 0                                   |
| fee         | 手续费                              |
| jsxf        | 净手续费                            |
| yhs         | 印花税                              |
| ghf         | 过户费                              |
| qtfee       | 手续费 - 过户费 - 印花税 - 净手续费 |
| lxs         | 0                                   |

**** Tn证券买入（220100）

- T+n证券买入在T+n日入账。此时在核算上已经和T+0买入的证券没有区别，只是成交价格是T日确定的。
- 核算办法同：证券买入（220000）


**** 沪港通股票买入（220094）

- 核算办法同：证券买入（220000）


*** 交易卖出
**** 证券卖出（221001）

- 成交数量按照平均价格影响成本
- 卖出价格和平均持仓价格之差乘以卖出数量为投资收益（可正可负）
- 应检查卖出数量在可允许范围之内


- 卖出数量 += 成交数量
- 卖出金额 += 成交金额

| 借方     | 贷方     | 金额                           |
|----------+----------+--------------------------------|
| 资金余额 | 投资收益 | 成交金额                       |
| 投资收益 | 库存成本 | 库存成本 * 成交数量 / 库存数量 |
| 其它费   | 资金余额 | 手续费                         |
| 印花税   | 其它费   | 印花税                         |
| 净手续费 | 其它费   | 净手续费                       |

- 资金余额 += 成交金额 - 手续费
- 投资收益 += 成交金额 - 库存成本 * 成交数量 / 库存数量
- 库存成本 -= 库存成本 * 成交数量 / 库存数量
- 净手续费 += 净手续费
- 印花税   += 印花税
- 其他费   += 手续费 - 印花税 - 净手续费

| action      | 0S                                        |
| matchqty    | 成交数量                                  |
| matchamt    | 成交金额                                  |
| matchamt_ex | 0                                         |
| aiamount    | 0                                         |
| fundeffect  | 成交金额 - 手续费                         |
| stkeffect   | - 成交数量                                |
| stkcost_ch  | - 库存成本 * 成交数量 / 库存数量          |
| syvalue_ch  | 成交金额 - 库存成本 * 成交数量 / 库存数量 |
| aicost_ch   | 0                                         |
| lxsr_ch     | 0                                         |
| fee         | 手续费                                    |
| jsxf        | 净手续费                                  |
| yhs         | 印花税                                    |
| ghf         | 过户费                                    |
| qtfee       | 手续费 - 过户费 - 印花税 - 净手续费       |
| lxs         | 0                                         |


**** Tn证券卖出（221101）

- T+n证券卖出在T+n日入账。此时在核算上已经和T+0卖出的证券没有区别，只是成交价格是T日确定的。
- 核算办法同：证券卖出（221001）

**** 沪港通股票卖出（220095）

- 核算办法同：证券卖出（221001）


*** 内部转入
*** 内部转出
*** 外部转入
*** 外部转出
*** 红股红利
**** 红利入账（2-21007）

- 成交金额入利息收入
- 无费用处理

| 借方     | 贷方     | 金额     |
|----------+----------+----------|
| 资金余额 | 利息收入 | 成交金额 |

- 资金余额 += 成交金额
- 利息收入 += 成交金额

- 红利金额 += 成交金额

**** 基金红利拨入（240507）

- 核算办法同：红利入账（221007）

**** 沪港通红利发放（220096）

- 核算办法同：红利入账（221007）

**** 债券兑息（221008）

- 核算办法同：红利入账（221007）
- 可从证券代码区分股票分红和债券利息


**** 红利认领（150032）

- 核算办法同：红利入账（221007）

**** 红股入账（220010）

- 只有成交数量，增加持仓数量但不影响成本（红股价格为零）
- 不影响资金
- 无费用处理

- 红股数量 += 成交数量


*** 股票配股
*** 质押入库
*** 质押出库
*** 证券融入
*** 证券融出
*** 基金申购
*** 基金赎回
*** 其它类型
**** 债券兑付（221009）

- 有还份数和降低票面两种情况。区分标准是看成交数量。
  - 成交数量 > 0：还份数，视为卖出
  - 成交数量 = 0：降低票面价格
- 还本价格（100）和平均持仓价格之差乘以还本数量为投资收益（可正可负）

若为还份数情况：

| 借方     | 贷方     | 金额                           |
|----------+----------+--------------------------------|
| 资金余额 | 投资收益 | 成交金额                       |
| 投资收益 | 库存成本 | 库存成本 * 成交数量 / 库存数量 |


- 资金余额 += 成交金额
- 投资收益 += 成交金额 - 库存成本 * 成交数量 / 库存数量
- 库存成本 -= 库存成本 * 成交数量 / 库存数量

- 库存数量 -= 成交数量

若为降低票面价格情况：

| 借方     | 贷方     | 金额                                     |
|----------+----------+------------------------------------------|
| 资金余额 | 投资收益 | 成交金额                                 |
| 投资收益 | 库存成本 | 库存成本 * 成交金额 /（100 * 库存数量）  |

- 资金余额 += 成交金额
- 投资收益 += 成交金额 - 库存成本 * 成交金额 /（100 * 库存数量）
- 库存成本 -= 库存成本 * 成交金额 /（100 * 库存数量）

**** 查询收费（222006）

- 前台费入其它费
- 不影响持仓成本

| 借方   | 贷方     | 金额   |
|--------+----------+--------|
| 其他费 | 资金余额 | 前台费 |

- 其它费   += 前台费
- 资金余额 -= 前台费



**** 偿还融资负债本金（552017）
**** 银行转证券（160021）
**** 证券转银行（160022）
**** 偿还融资利息（552001）
**** 担保品卖出（550005）
**** 担保品买入（550001）
**** 利息归本（140011）
**** 申购还款（221024）
**** 新股申购（220023）
**** 基金申购拨出（240509）
**** ETF 赎回增股（220039）
**** 融资买入（550002）
**** 融资借入（553001）
**** 融资借出（553002）
**** ETF 申购减股（221036）
**** 股息红利差异扣税（140203）
**** 融券购回（221035）
**** 融券回购（220003）
**** 基金赎回拨入（240511）

**** 指定交易（220032）
**** 卖券还款（550003）
**** 沪港通组合费（220097）

**** ETF 现金替代返款（221040）
**** ETF 现金替代扣款（220041）
**** 还券划出（551007）
**** 新股入帐（220004）
**** 开放基金赎回（221049）
**** 申购中签（220027）
**** 报价融券回购（220006）
**** 报价融资回购（221003）
**** 报价融资购回（220035）
**** 报价融券购回（221033）
**** ETF 申购退款（221038）
**** 开放基金申购（220049）
**** 股份转出（221006）
**** 偿还融券负债（552018）
**** 融券卖出（550006）
**** 融券借入（553003）
**** 融券借出（553004）
**** 担保物转入（551001）
**** 开放基金拆分增股（220056）
**** 偿还融券费用（552003）
**** 台帐间现金划转存（140055）
**** 台帐间现金划转取（140057）
**** 股份转入（220005）
**** 担保物转出（551005）
**** 开放基金合并减股（221056）
**** ETF 基金赎回（221037）
**** ETF 基金申购（220038）

**** ETF 现金差额返款（221039）
**** ETF 现金差额扣款（220042）
**** 基金认购拨出（240508）
**** 融资购回（220034）
**** 融资回购（221002）
**** 定时定额申购拨出（240510）
**** 限售股转让扣税（221042）
**** 配股权证（221011）
**** 配售缴款（220031）
**** 配售股份（220030）
**** 配股缴款（220012）
**** 配股入帐（221013）
**** 开放基金拆分减股（221057）
**** 买券还券（550007）
**** ETF 赎回收费（220048）
**** 基金上折（220137）
**** 基金下折（220138）
**** 删除过期证券（110434）
**** 股票质押初始融资（221204）
**** 股票质押融券购回（221343）
**** 股票质押初始融券（221207）
**** 股票质押融资购回（221243）
**** EFT 申购收费（220047）
**** 撤销指定（220033）
**** ETF 申购补扣（220040）
**** 金融认购拨出（260508）
**** 开放基金合并增股（220057）
**** 撤指转出（221032）
**** 投票确认（222004）
**** 金融强行赎回拨入（260512）
**** 质押入库（221060）
**** LOF认购（220024）
**** 指定入帐（220016）
**** 转托管出（221014）
**** 股票质押借方部分（221253）
**** 三方存管现金蓝补（940008）
**** 报价融资提前购回（221023）
**** 报价融券提前购回（221034）
**** 质押出库（220060）
**** 三方存管现金红冲（940029）
**** 转托管入（220015）
**** 偿还融资逾债罚息（552012）
**** 基金申购失败拨入（240514）
**** 基金强行赎回拨入（240512）
**** 偿还融资逾期利息（552006）
**** 偿还融资逾利罚息（552011）
**** 股份认领（150030）
**** 债券转股回售转出（221017）
**** 转股入帐（220018）
**** 转股零款（221031）
**** 融资平仓（550004）
**** 证券分拆记增/基（551021）
**** 偿还融券头寸全额（552037）
**** 偿还融券特殊占用（552030）
**** 证券分拆记减/基（551020）
**** 上证LOF确认返款（220136）
**** OTC资金划出（140212）
**** 上证LOF赎回（220085）
**** 基金认购失败拨入（240513）
**** 偿还融资头寸全额（552034）
**** 余券转入（551004）
**** 余券转出（551008）
**** 还券转余券（554007）
**** 偿还融券权益金额（552008）
**** 还转融通证券本券（550122）
**** 收转融通证券本券（550121）
**** 券源划出（551006）
**** 上证LOF确认扣款（220135）
**** 调帐转帐转入（168007）
**** OTC资金划入（140211）
**** 上证LOF申购（220084）
**** 转帐支票取（140024）
**** 自主行权扣款（220058）
**** 自主行权增股（220059）
**** 股息红利扣税蓝补（140205）
**** 内部转托管出（150028）
**** 调帐转帐转出（168008）
**** 配股退款退息（221012）
**** 转融通出借归还（221091）
**** 转融通出借利息（221092）
**** 快速过户拨入（240562）
**** 自主行权提交所得（580509）
**** 冲正证券转银行（160024）
**** 转帐支票存（140004）
**** 证券红冲（150001）
**** 偿还融资头寸空闲（552036）
**** 定时定额失败拨入（240515）
**** 基金清盘资金拨入（240521）
**** 转融通出借证券（221090）
**** 偿还融券逾期费用（552009）
**** 港股通送股上市（220114）
**** 港股通非交易出（220116）
**** 股票质押借方补质（221251）
**** 偿还融券逾费罚息（552015）
**** 偿还融券逾债罚息（552016）
**** 券源划入（551002）
**** 股票质押利息扣收（140200）
**** 证券蓝补（150002）
**** 要约资金（221022）
**** 债券回售赎回资金（221019）
**** 要约确认（220020）
**** 融券平仓（550008）
**** 要约解除（221021）
**** 港股通非交易入（220115）
**** 基金交易资金划入（240516）
**** 保险资金划出（140502）
**** 转融通出借权益（221095）
**** 现金红冲（140029）
**** 沪港通权证卖出（220099）
**** 存折取（140022）
**** 国债预发额度注册（221350）
**** 国债预发额度注销（221351）
**** 股票质押利息偿还（141106）
**** 现金取（140021）
**** 现金蓝补（140008）
**** 开放基金强行赎回（221050）
**** 预发行卖资金清算（221357）
**** 三方存管加银行+（940012）
**** 三方存管加银行-（940013）
**** 存折存（140002）
**** 沪港通供股（220121）
**** 预发行买资金清算（221356）
**** 约定融券回购（220007）
**** 开放基金认购（220050）
**** 开放基金认购入帐（220051）
**** 约定融资回购（221004）
**** 现金存（140001）
**** 三方存管减银行-（940010）
**** 三方存管减银行+（940011）
**** 港股通撤指交易（220119）
**** 国债预发行客买入（221352）
**** 国债预发行客卖出（221353）
**** 开放基金认购退款（220054）
**** 约定融资购回（220043）
**** 约定融券购回（221043）
**** 冲正银行转证券（160023）
**** 支票蓝补（140009）
**** 支票红冲（140030）
**** 还转融通权益补偿（550126）
**** 基金资金拨出（240502）
**** 报价入库（221067）
**** 非公开优先股转出（220093）
**** 报价出库（220067）
**** 专户基金申购（220090）
**** 内部转托管出取消（150031）
**** 理财产品转让拨入（240523）
**** 理财产品转让拨出（240524）
**** 转托管费（222003）
**** 银证转帐调帐存（160031）
**** 偿还融资管理费（552002）
**** 余券红利划入（554003）
**** 余券红利划出（554004）
**** 专户基金赎回（220091）
**** 沪港通零股现金（220108）
**** 港股通指定交易（220118）
**** 银证转帐调帐取（160032）
**** 罚息归本（140032）






