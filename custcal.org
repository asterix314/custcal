#+TODO: TODO | DONE
#+TODO: OPEN | CLOSED


* 经纪业务客户核算设计

** 总体要求

*** 客户范围
全体经纪业务客户，同一名客户A股、B股、融资融券、开放式基金、黄金、OTC、期权业务等需要统一核算。同一名客户是指同一个营业部号下的客户号相同（orgid,custid）。

*** 精确性要求
要求精准核算，每一笔流水需要确认清楚，计算准确。即按照业务发生的适用情形，分别计算出相关证券的股份增减、成本增减、净价损益、利息收入、各类税费以及融资利息和融券费用等各项科目，以及准确计量各项统计数据，比如累计成交数量、成交金额等；对于个别不能系统自动确认的业务流水，需要梳理清楚，通过设计机制来解决（不能牺牲精度），包括由运行人员手工确认后再做处理等。总之，每一笔流水处理要准确，不可草率处理。

*** 及时性要求
当晚产生核算结果，通过接口提供给CRM系统后，由外围系统调用对客户提供揭示。要求系统性能较好，能支持在30分钟内完成每天5百万流水的业务处理，以及5百万以上持仓的公允价值和预计利息的计提处理，以及后续数据校验核对和数据汇总、数据归档、磁盘备份等步骤。

*** 输出
客户资产情况，成交情况，交易特点，盈亏能力，贡献（含交易佣金、息差、融资融券息费等），税费支出、融资融券情况等进行全方位核算。

** 核算输入输出

#+NAME: tab:核算对象
|--------------+-----------------------+----------|
| 对象名称     | 数据库对象            | 对象类型 |
|--------------+-----------------------+----------|
| 业务流水     | logasset_hs           | 输入     |
| 业务流水索引 | logasset_hs_pk        | 输入     |
| 持仓核算     | stkasset_hs           | 输出     |
| 持仓核算索引 | stkasset_hs_pk        | 输出     |
| 资金核算     | fundasset_hs          | 输出     |
|--------------+-----------------------+----------|

_zch_1125

*** 输入：业务流水表

#+NAME: fld:表字段定义
|----------+------+----------+-------------+------------------------------------|
| 变量名称 | 类型 | 表       | 字段        | 说明                               |
|----------+------+----------+-------------+------------------------------------|
| 节点号   | 信息 | 业务流水 | serverid    |                                    |
| 交收日期 | 信息 | 业务流水 | bizdate     | 以交收日期为核算日期               |
| 交易日期 | 信息 | 业务流水 | orderdate   |                                    |
| 委托序号 | 信息 | 业务流水 | orderid     |                                    |
| 委托号   | 信息 | 业务流水 | ordersno    |                                    |
| 交易序号 | 信息 | 业务流水 | sno         | 业务流水标识 说明 2）              |
| 关联序号 | 信息 | 业务流水 | ref_sno     |                                    |
| 关联代码 | 信息 | 业务流水 | ref_stkcode |                                    |
| 机构号   | 信息 | 业务流水 | orgid       |                                    |
| 客户号码 | 信息 | 业务流水 | custid      |                                    |
| 资金账号 | 信息 | 业务流水 | fundid      |                                    |
| 证券账号 | 信息 | 业务流水 | secuid      |                                    |
| 货币代码 | 信息 | 业务流水 | moneytype   | 0人民币、1港币、2美元              |
| 业务摘要 | 信息 | 业务流水 | digestid    |                                    |
| 市场代码 | 信息 | 业务流水 | market      | 0深A、1沪A、2深B 、3沪B            |
| 证券代号 | 信息 | 业务流水 | stkcode     |                                    |
| 银行代号 | 信息 | 业务流水 | bankcode    |                                    |
| 资金发生 | 信息 | 业务流水 | fundeffect  |                                    |
| 资金余额 | 信息 | 业务流水 | fundbal     |                                    |
| 股份发生 | 信息 | 业务流水 | stkeffect   |                                    |
| 股份余额 | 信息 | 业务流水 | stkbal      |                                    |
| 成交数量 | 信息 | 业务流水 | matchqty    | 股份实际成交数量或者转托管等的数量 |
| 成交金额 | 信息 | 业务流水 | matchamt    |                                    |
| 成交价格 | 信息 | 业务流水 | matchprice  |                                    |
| 券商佣金 | 信息 | 业务流水 | fee_jsxf    | 说明 1)                            |
| 手续费   | 信息 | 业务流水 | fee_sxf     | 说明 1)                            |
| 过户费   | 信息 | 业务流水 | fee_ghf     | 说明 3)                            |
| 印花税   | 信息 | 业务流水 | fee_yhs     | 说明 4)                            |
| 前台费   | 信息 | 业务流水 | feefront    | 归入"其它费"                       |
| 操作方式 | 信息 | 业务流水 | operway     |                                    |
| 买卖类别 | 信息 | 业务流水 | bsflag      |                                    |
| 备注     | 信息 | 业务流水 | remark      |                                    |
| 核算状态 | 信息 | 业务流水 | sett_status |                                    |
| 核算备注 | 信息 | 业务流水 | sett_remark |                                    |
|----------+------+----------+-------------+------------------------------------|


说明  
1)  用户付出的手续费，减去交易所费用等，才是CSC收到的净手续费。手续费不含印花税、过户费、前台费。
2)  根据节点号、交收日期、交易序号可唯一确定一条交易流水。PRIMARY KEY (serverid, bizdate, sno)
3)  过户费是指委托买卖的股票、基金成交后买卖双为变更股权登记所支付的费用。
    - 这笔收入属于证券登记清算机构的收入。
    - 由CSC在同投资者清算交割时代为扣收。
4)  印花税：只对卖出方（或继承、赠与A股、B股股权的出让方）征收证券（股票）交易印花税。
    - 对买入方(受让方)不征税。
    - 税率为 1‰。

**** OPEN 外币处理
货币一般为人民币。如遇外币，原则是每种货币分开核算。如需加总（如计算总资产totalvalue时），则需按照汇率折成人民币处理。具体处理方式待定。

**** OPEN 关联序号
有两个字段（ref_sno, relativesno）都表示关联序号？

**** OPEN creditid，creditflag，bsflag作用？

*** 输出：持仓核算表

输出表的字段分三类：
-  交易信息 :: 一般为非数值量，来自业务流水表等记录交易信息的字段。
-  会计科目 :: 能够用复式记账法进行核算的会计科目。资产 + 费用 = 负债 + 收益。
-  统计量 :: 对会计科目的进一步加工（汇总、差分等）或对交易细节的记录。

变动类字段，在每天的初始化阶段会清零。所以核算过程中只要和其对应的加总字段一致变化即可。

持仓头寸归集标准为：
  - 节点号、营业部号、客户号、资金账号、市场、证券代码、流通类型。
  - 凡以上七个字段相同的操作，影响同一个证券持仓头寸。

#+NAME: fld:表字段定义
|------------------+----------+----------+---------------+-------------------------------------------------|
| 变量名称         | 类型     | 表       | 字段          | 说明                                            |
|------------------+----------+----------+---------------+-------------------------------------------------|
| 节点号           | 信息     | 持仓核算 | serverid      | 节点A：1-3，B股：7，融资融券：8                 |
| 营业部号         | 信息     | 持仓核算 | orgid         | 对应业务流水相同字段                            |
| 客户号           | 信息     | 持仓核算 | custid        | 对应业务流水相同字段                            |
| 资金帐号         | 信息     | 持仓核算 | fundid        | 对应业务流水相同字段                            |
| 市场             | 信息     | 持仓核算 | market        | 0深A 1沪A 2深B 3沪B J基金 5沪港通 6？ 8融资融券 |
| 证券代码         | 信息     | 持仓核算 | stkcode       | 对应业务流水相同字段                            |
| 市场价格         | 信息     | 持仓核算 | stkprice      | 市场数据表的收盘价                              |
| 流通类型         | 信息     | 持仓核算 | ltlx          | 说明 1)                                         |
| 计提日期         | 信息     | 持仓核算 | jtdate        | 说明 2)                                         |
| 公允日期         | 信息     | 持仓核算 | gydate        | ？                                              |
| 备注             | 信息     | 持仓核算 | remark        | 内容不做限制                                    |
|------------------+----------+----------+---------------+-------------------------------------------------|
| 买入数量         | 表外贷方 | 持仓核算 | stkbuyqty     | 二级市场买卖交易，统计客户交易量用              |
| 买入金额         | 表外贷方 | 持仓核算 | stkbuyamt     |                                                 |
| 卖出数量         | 表外借方 | 持仓核算 | stksaleqty    | 二级市场买卖交易，统计客户交易量用              |
| 卖出金额         | 表外借方 | 持仓核算 | stksaleamt    |                                                 |
| 申购数量         | 表外贷方 | 持仓核算 | stkbuyqty_ex  | 如LOF、ETF申购、基金认购等                      |
| 其它买入金额     | 表外贷方 | 持仓核算 | stkbuyamt_ex  | 说明 3)                                         |
| 赎回数量         | 表外借方 | 持仓核算 | stksaleqty_ex | 如LOF、ETF赎回、基金赎回等                      |
| 其它卖出金额     | 表外借方 | 持仓核算 | stksaleamt_ex | 说明 3)                                         |
| 转入数量         | 表外贷方 | 持仓核算 | stkztgrqty    | 说明 4)                                         |
| 转入金额         | 表外贷方 | 持仓核算 | stkztgramt    | 说明 4)                                         |
| 转出数量         | 表外借方 | 持仓核算 | stkztgcqty    | 说明 4)                                         |
| 转出金额         | 表外借方 | 持仓核算 | stkztgcamt    | 说明 4)                                         |
| 红股数量         | 表外贷方 | 持仓核算 | stkhgqty      | 红股价格视为零                                  |
| 红利金额         | 表外贷方 | 持仓核算 | stkhlamt      |                                                 |
| 配股数量         | 表外贷方 | 持仓核算 | stkpgqty      | 视为以配股价格购入                              |
| 配股金额         | 表外贷方 | 持仓核算 | stkpgamt      |                                                 |
| 持仓数量         | 表外借方 | 持仓核算 | stkqty        |                                                 |
| 调整数量         | 表外借方 | 持仓核算 | stkqty_tz     | 说明 9)                                         |
| 调整金额         | 表外借方 | 持仓核算 | stkqty_tzje   | 说明 9)                                         |
| 质押数量         | 表外借方 | 持仓核算 | stkpledge     | 说明 5)                                         |
| 借入数量         | 表外贷方 | 持仓核算 | stkdebt       | 说明 6)   ?                                     |
| 借出数量         | 表外借方 | 持仓核算 | stkloan       | 说明 6)                                         |
| 毛手续费         | 表外贷方 | 持仓核算 | sxf           |                                                 |
|------------------+----------+----------+---------------+-------------------------------------------------|
| 持仓成本         | 表内借方 | 持仓核算 | stkcost       |                                                 |
| 外部转托金额     | 表内借方 | 持仓核算 | stkadjust     | 说明 7)                                         |
| 交易收益         | 表内贷方 | 持仓核算 | syvalue       | 核算买卖价差损益（平均成本法）                  |
| 浮动盈亏         | 表内贷方 | 持仓核算 | gyvalue       | 等于：市值金额 - 持仓成本                       |
| 利息收入         | 表内贷方 | 持仓核算 | lxsr          | 说明 11)                                        |
| 借出利息收入     | 表内贷方 | 持仓核算 | cjsr          | 出借资券业务的收入                              |
| 借入利息费用     | 表内贷方 | 持仓核算 | jrzc          | 借入资券业务的支出，含质押式融资融券            |
| 预计利息         | 表内借方 | 持仓核算 | aiamount      | 说明 10)                                        |
| 净手续费         | 表内借方 | 持仓核算 | jsxf          | 即券商佣金                                      |
| 印花税费         | 表内借方 | 持仓核算 | yhs           |                                                 |
| 过户费用         | 表内借方 | 持仓核算 | ghf           |                                                 |
| 其它费用         | 表内借方 | 持仓核算 | qtfee         |                                                 |
| 利息税费         | 表内借方 | 持仓核算 | lxs           |                                                 |
| 利息成本         | 表内贷方 | 持仓核算 | aicost        | 说明 10)                                        |
|------------------+----------+----------+---------------+-------------------------------------------------|
| 债券票面利息     | 统计     | 持仓核算 | bondintr      | 说明 10)                                        |
| 利息计提         | 统计     | 持仓核算 | lxjt          | 说明 10)                                        |
| 市值金额         | 统计     | 持仓核算 | mktvalue      | 等于 市场价格 * 持仓数量                        |
|------------------+----------+----------+---------------+-------------------------------------------------|
| 持仓数量变动     | 变动     | 持仓核算 | stkqty_ch     |                                                 |
| 持仓成本变动     | 变动     | 持仓核算 | stkcost_ch    |                                                 |
| 浮动盈亏变动     | 变动     | 持仓核算 | gyvalue_ch    |                                                 |
| 交易收益变动     | 变动     | 持仓核算 | syvalue_ch    |                                                 |
| 利息收入变动     | 变动     | 持仓核算 | lxsr_ch       |                                                 |
| 借出利息收入变动 | 变动     | 持仓核算 | cjsr_ch       |                                                 |
| 借入利息费用变动 | 变动     | 持仓核算 | jrzc_ch       |                                                 |
| 回购利息变动     | 变动     | 持仓核算 | hglx_ch       |                                                 |
| 总计费用变动     | 变动     | 持仓核算 | fee_ch        |                                                 |
| 净手续费变动     | 变动     | 持仓核算 | jsxf_ch       |                                                 |
| 印花税变动       | 变动     | 持仓核算 | yhs_ch        |                                                 |
| 过户费变动       | 变动     | 持仓核算 | ghf_ch        |                                                 |
| 利息税变动       | 变动     | 持仓核算 | lxs_ch        |                                                 |
| 其它费变动       | 变动     | 持仓核算 | qtfee_ch      |                                                 |
| 利息成本变动     | 变动     | 持仓核算 | aicost_ch     |                                                 |
| 利息计提变动     | 变动     | 持仓核算 | lxjt_ch       |                                                 |
| 毛手续费变动     | 变动     | 持仓核算 | sxf_ch        |                                                 |
| 外部转托金额变动 | 变动     | 持仓核算 | stkadjust_ch  |                                                 |
|------------------+----------+----------+---------------+-------------------------------------------------|


说明
1)  流通类型（ltlx）相当于证券代码的补充。包括：00流通股 01限售流通 03申购状态 06融资回购 07融券回购 80多仓 81空仓。
    - 正常情况下一般都是00流通股，涉及到新股申购、未上市股份、融资融券、期货期权时才不为00。
2)  计提的目的是更新市场价值（MTM）和利息积数（accrual），是每天的一次操作。
    - 在核算完成后由外部单独步骤“公允与利息处理”触发。
3)  不参与交易量统计,非交易量金额，如ETF申赎现金替代、转债转股资金、行权资金等。
4)  是指在公司内部不同资产形式的转换，区别从外部转入转出的资产。
    - 含转托管入或出、ETF申赎转入或出、转债转股入或出、合并拆分入或出、ETF认购入或出、其他转换类入或出等。
    - 转入转出价格一般指定为当日收盘价格。不影响资金发生。 
5)  质押的证券不影响成本。相当于把证券“冻结”，因此会限制可出售的证券数量。
6)  借出证券不影响成本。但会减少允许出售的份数。
7)  外部转托管金额记录非我公司资产之间的转入转出。此项引起的资产增加或减少，视同基金的申购或退出。
    - 参考价格为当日收盘价。
9)  调整数量和调整金额可正可负。用于分红到帐和除权除息不同步时校正市值。
10) 与债券利息有关各统计量的关系：
    - 预计利息是截至当天属于客户，但还未交收的利息。
    - 预计利息 = 持仓数量 * 债券票面利息 = 利息成本 + 利息计提
    - 利息成本是所有债券交易全价与净价之差部分的累积（前手息）。
    - 债券卖出时，利息成本按卖出数量与持仓数量的比例计减。
    - 利息计提是由于客户持有债券挣得的利息部分。
    - 利息计提 = 预计利息 - 利息成本
    - 债券票面利息 = 预计利息 / 持仓数量
11) 利息收入核算已经交收的股息或者债券利息。
    - 判断是股息还是债券利息，可由证券代码进行区分。
    - 卖出债券时，按照卖出利息金额-利息成本记增。（合理？）


**** OPEN 公允日期
和“计提日期”的关系？gydate = jtdate?

**** OPEN 债券票面利息
债券票面利息bondintr和利息收入lxsr有什么区别？债券每日计提利息的金额在哪里保存？
债券卖出时利息收入的计算按利息成本平均，是否合理？

**** OPEN 借入的证券，如何核算成本？
比如出售借入的证券，按什么成本核算损益？
涉及借入证券的业务是否为：融券借入（553003）？



*** 输出：资金资产核算表

资金头寸归集标准为：
  - 节点号、营业部号、客户号、银行代码、资金账号、货币类型。
  - 凡以上六个字段相同的操作，影响同一个资金头寸。

#+NAME: fld:表字段定义
|------------------+----------+----------+---------------+-----------------------------------------------|
| 变量名称         | 类型     | 表       | 字段          | 说明                                          |
|------------------+----------+----------+---------------+-----------------------------------------------|
| 节点号           | 信息     | 资金核算 | serverid      | 对应业务流水相同字段                          |
| 营业部号         | 信息     | 资金核算 | orgid         | 对应业务流水相同字段                          |
| 客户号           | 信息     | 资金核算 | custid        | 对应业务流水相同字段                          |
| 资金帐号         | 信息     | 资金核算 | fundid        | 对应业务流水相同字段                          |
| 货币类型         | 信息     | 资金核算 | moneytype     | 对应业务流水相同字段                          |
| 银行代码         | 信息     | 资金核算 | bankcode      | 开户行标识                                    |
| 统计日期         | 信息     | 资金核算 | tjdate        |                                               |
| 备注             | 信息     | 资金核算 | remark        | 不限制内容                                    |
|------------------+----------+----------+---------------+-----------------------------------------------|
| 账户资金         | 表内借方 | 资金核算 | fundbal       | 受借出、借入的金额会影响                      |
| 存款金额         | 表内贷方 | 资金核算 | fundsave      |                                               |
| 取款金额         | 表内借方 | 资金核算 | fundunsave    |                                               |
| 借出金额         | 表内借方 | 资金核算 | fundloan      |                                               |
| 借入金额         | 表内贷方 | 资金核算 | funddebt      |                                               |
| 在途未收         | 表内借方 | 资金核算 | funduncome    | 应收账款                                      |
| 在途未付         | 表内贷方 | 资金核算 | fundunpay     | 应付账款                                      |
| 利息积数         | 表内贷方 | 资金核算 | fundintr      | 未发放的利息收入 说明 1)                      |
| 累计结息         | 表内贷方 | 资金核算 | fundaward     | 已经发放的利息收入 说明 1)                    |
| 融资利息         | 表内贷方 | 资金核算 | rzlx          |                                               |
|------------------+----------+----------+---------------+-----------------------------------------------|
| 账户资金变动     | 变动     | 资金核算 | fundbal_ch    |                                               |
| 取款金额变动     | 变动     | 资金核算 | fundunsave_ch |                                               |
| 存款金额变动     | 变动     | 资金核算 | fundsave_ch   |                                               |
| 借出金额变动     | 变动     | 资金核算 | fundloan_ch   |                                               |
| 借入金额变动     | 变动     | 资金核算 | funddebt_ch   |                                               |
| 在途未收变动     | 变动     | 资金核算 | funduncome_ch |                                               |
| 在途未付变动     | 变动     | 资金核算 | fundunpay_ch  |                                               |
| 利息积数变动     | 变动     | 资金核算 | fundintr_ch   |                                               |
| 累计结息变动     | 变动     | 资金核算 | fundaward_ch  |                                               |
| 融资利息变动     | 变动     | 资金核算 | rzlx_ch       |                                               |
|------------------+----------+----------+---------------+-----------------------------------------------|
| 外部资产增减变动 | 统计     | 资金核算 | fundadjust_ch | 等于：差分 外部资产增减                       |
| 外部资产增减     | 统计     | 资金核算 | fundadjust    | 说明 2)                                       |
| 上日余额         | 统计     | 资金核算 | fundlastbal   |                                               |
| 净资产           | 统计     | 资金核算 | totalvalue    | 说明 3)                                       |
| 单位净值         | 统计     | 资金核算 | nav           | 说明 4)                                       |
| 总市值           | 统计     | 资金核算 | mktvalue      | 等于：持仓核算表.市值金额，对所有证券代码求和 |
| 总份额           | 统计     | 资金核算 | totalfe       | 说明 5)                                       |
|------------------+----------+----------+---------------+-----------------------------------------------|


说明
1) 客户资金按活期存款计息，每季度发放。
    - 发放的总额就是累计结息。
    - 利息积数记录在发放利息之前已经累积的利息金额。类似于利息计提。
2)  包括资金转入转出或者外部转托管，影响折算份额的计算。
3)  总资产记录客户的净资产（资产－负债），包含客户持有的所有证券和现金。
    - 等于：总市值 + 本日余额 + 借出金额 + 预计利息 + 在途未收 + 利息积数 - 借入金额 - 在途未付
4)  单位净值等于：总资产/总份额，年初初始化为1，根据净值增减评判盈利能力。
5)  年初初始化,后续根据存取款按照当日单位净值折算成申购或者退出份额。  


**** OPEN 关于客户盈利能力评价
为合理评价客户盈利能力，需处理由于资本金频繁增减带来的利润。一个想法是
把客户按照一只基金对待。相关的字段是：

- 外部转托金额：持仓核算.stkadjust  
- 外部资产增减：资金核算.fundadjust
- 外部资产增减变动：资金核算.fundadjust_ch
- 总资产：资金核算.totalvalue
- 单位净值：资金核算.nav
- 总市值：资金核算.mktvalue
- 总份额：资金核算.totalfe

目前尚没有想清楚具体处理逻辑，以上字段暂不参加核算。


#NAME: 统计变量
#+BEGIN_SRC js
    {
        "市场价值": "市场价格 * 持仓数量",
        "净资产":   "市场价值 + 账户资金 + 借出资金 + 预计利息 + 在途未收 + 利息积数  - 借入金额 - 在途未付",
        "总份额":   0,
        "单位净值": 0
    }
#+END_SRC


** 处理逻辑

*** 动作类型

动作类型是传给Stkasset_Commit函数的一个参数。

#+NAME: 动作类型定义
#+BEGIN_SRC js
  {
      {
          "动作类型": "0B",
          "说明":     "二级市场买入交易，一般会实际产生手续费。"
      },
      {
          "动作类型": "0S",
          "说明":     "二级市场卖出交易，一般会实际产生手续费。"
      },
          {
          "动作类型": "1B",
          "说明":     "一级市场申购。"
      },
      {
          "动作类型": "1S",
          "说明":     "一级市场赎回。"
      },
      {
          "动作类型": "ZR",
          "说明":     "内部转入。资产不同形式资产的转换，比如ETF股票换基金，可转债转换为股票等。"
      },
      {
          "动作类型": "ZC",
          "说明":     "内部转出。"
      },
      {
          "动作类型": "WR",
          "说明":     "外部转入。资产向我公司之外转出或者从外部转入进来。"
      },
      {
          "动作类型": "WC",
          "说明":     "外部转出。"
      },
      {
          "动作类型": "HG",
          "说明":     "红股红利。"
      },
      {
          "动作类型": "PG",
          "说明":     "配股。"
      },
      {
          "动作类型": "ZYR",
          "说明":     "质押入库。"
      },
      {
          "动作类型": "ZYC",
          "说明":     "质押出库。"
      },
      {
          "动作类型": "RR",
          "说明":     "证券融入。"
      },
      {
          "动作类型": "RC",
          "说明":     "证券融出。"
      },
      {
          "动作类型": "EB",
          "说明":     "ETF申购。"
      },
      {
          "动作类型": "ES",
          "说明":     "ETF赎回。"
      }
      
  }
#+END_SRC

*** 公共过程参数说明

nb_Cust_Stkasset_Commit

公共过程参数

|--------------+----------+--------------------------------------------------------|
| 参数名称     | 赋值     | 说明                                                   |
|--------------+----------+--------------------------------------------------------|
| @action      | 动作类型 | 动作类型                                               |
| @matchqty    | 成交数量 | 成交数量                                               |
| @matchamt    | 成交金额 | 成交金额                                               |
| @matchamt_ex | 0        | 成交金额扩展                                           |
| @aiamount    | 0        | 债券票面金额，债券成交金额+债券票面金额=实际发生金额。 |
| @fundeffect  | 账户资金 | 资金发生数，指实际资金发生数                           |
| @stkeffect   | 持仓数量 | 股份变动，股份实际变动数量，区别正负号                 |
| @stkcost_ch  | 持仓成本 | 买入记增，卖出按实际数量摊销后记减                     |
| @syvalue_ch  | 交易收益 | 卖出或划出时，按照卖出金额减去摊销成本记增             |
| @aicost_ch   | 利息成本 | 利息成本，债券买入记增，卖出按实际数量摊销后记减       |
| @lxsr_ch     | 利息收入 |                                                        |
| @jsxf        | 净手续费 | 券商佣金                                               |
| @yhs         | 印花税   | 印花税                                                 |
| @ghf         | 过户费   | 过户费                                                 |
| @qtfee       | 其它费   | 其它费                                                 |
| @lxs         | 利息税   | 利息税                                                 |
|--------------+----------+--------------------------------------------------------|


说明
- 成交金额扩展，不对应真实资金发生，一般指证券替换类业务证券市值折算出的金额。
  - 例如ETF申购赎回或债券转股，证券转托管折算的金额，此字段用于统计金额，永远为正数。
- 利息收入，债券卖出或兑付兑息火划出时，按照卖出利息金额减去摊销利息成本记增。
  
         


** 业务核算处理

#+NAME: 会计科目
#+BEGIN_SRC js
  {
      "费用":      ["净手续费","印花税费","过户费用","利息税费","其它费用","借入费用"],
      "证券成本":  ["持仓成本"],
      "金融资产":  ["账户资金","借出资金","借出证券"],
      "应收账款":  ["预计利息","在途未收","利息积数"]
      "表外借方":  ["卖出数量","转出数量","借出数量","表外对拆","配股数量","调整数量","卖出金额",
                    "持仓数量","还本数量","其它卖出金额","转出金额","调整金额","表外对拆"],
      "资本取出":  ["取出资金"],
      "金融负债":  ["借入资金","借入证券"],
      "应付账款":  ["在途未付"],
      "损益":      ["浮动盈亏","价差损益","利息收入","借出收入","活期利息"],
      "资本存入":  ["存入资金"],
      "表外贷方":  ["买入数量","转入数量","质押数量","借入数量","买入金额","红利金额","其它买入金额",
                    "转入金额","配股金额","红股数量"]
  }
#+END_SRC


#+NAME: 错误处理
#+BEGIN_SRC
  <|
      "普通买入"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect<=0",
              "错误信息"-> "股票发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=@stkeffect",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@matchamt<=0",
              "错误信息"-> "成交金额与该业务不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@matchamt+@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "普通买入（价格=matchprice）"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect<=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=@stkeffect",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@matchamt!=@matchqty*@matchprice",
              "错误信息"-> "成交金额不等于成交数量*成交价格."
          |>,          
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@matchamt+@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "行权缴款"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect>=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty+@stkeffect!=0",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_jsxf<0 or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@matchamt+@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "行权缴款（fee=0）"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect!=0",
              "错误信息"-> "股票发生应为零."
          |>,
          <|
              "错误条件"-> "@matchqty<=0",
              "错误信息"-> "成交数量与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt<=0",
              "错误信息"-> "成交金额与该业务不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@matchamt+@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "持仓上账"->
      {
          <|
              "错误条件"-> "@fundeffect!=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect<=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=@stkeffect",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>
      },
      "持仓下账"->
      {
          <|
              "错误条件"-> "@fundeffect!=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect>=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty+@stkeffect!=0",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>
      },
      "持仓下账（matchqty=0）"->
      {
          <|
              "错误条件"-> "@fundeffect!=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect>=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=0",
              "错误信息"-> "成交数量不为零."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>
      },
      "股份认领"->
      {
          <|
              "错误条件"-> "@fundeffect!=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect<=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=0",
              "错误信息"-> "成交数量与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt!=0",
              "错误信息"-> "成交金额不为零."
          |>,
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_jsxf<0 or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>
      },
      "申购中签"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect<=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=@stkeffect",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@matchamt!=@matchqty*@matchprice",
              "错误信息"-> "成交金额不等于成交数量*成交价格."
          |>,          
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@matchamt+@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "申购还款"->
      {
          <|
              "错误条件"-> "@fundeffect<=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect>=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty+@stkeffect!=0",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@matchamt!=@matchqty*@matchprice",
              "错误信息"-> "成交金额不等于成交数量*成交价格."
          |>,          
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=@matchamt",
              "错误信息"-> "资金发生不等于成交金额减费用."
          |>
      },
      "普通卖出"->
      {
          <|
              "错误条件"-> "@fundeffect<=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect>=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty+@stkeffect!=0",
              "错误信息"-> "成交数量与股份发生不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=@matchamt",
              "错误信息"-> "资金发生不等于成交金额减费用."
          |>
      },
      "融资回购（价格=100）"->
      {
          <|
              "错误条件"-> "@fundeffect<=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty<=0",
              "错误信息"-> "成交数量与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt<=0",
              "错误信息"-> "成交金额与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt!=@matchqty*100",
              "错误信息"-> "成交金额不等于成交数量*100."
          |>,          
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_jsxf<0 or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=@matchamt",
              "错误信息"-> "资金发生不等于成交金额减费用."
          |>
      },
      "融资回购"->
      {
          <|
              "错误条件"-> "@fundeffect<=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty<=0",
              "错误信息"-> "成交数量与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt<=0",
              "错误信息"-> "成交金额与该业务不符."
          |>,    
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_jsxf<0 or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=@matchamt",
              "错误信息"-> "资金发生不等于成交金额减费用."
          |>
      },
      "融券回购（价格=100）"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty<=0",
              "错误信息"-> "成交数量与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt<=0",
              "错误信息"-> "成交金额与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt!=@matchqty*100",
              "错误信息"-> "成交金额不等于成交数量*100."
          |>,          
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_jsxf<0 or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@matchamt+@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "融券回购"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",  
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty<=0",
              "错误信息"-> "成交数量与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt<=0",
              "错误信息"-> "成交金额与该业务不符."
          |>,      
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_jsxf<0 or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@matchamt+@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "费用（校验和）"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect!=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=0",
              "错误信息"-> "成交数量与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchamt<0",
              "错误信息"-> "成交金额与该业务不符."
          |>,      
          <|
              "错误条件"-> "@fee_sxf<@fee_jsxf or @fee_jsxf<0 or @fee_ghf<0 or @fee_yhs<0 or @qtfee<0",
              "错误信息"-> "费用金额异常."
          |>,
          <|
              "错误条件"-> "@fee_sxf+@fee_ghf+@fee_yhs+@qtfee+@fundeffect+@matchamt!=0",
              "错误信息"-> "资金发生不等于成交金额加费用."
          |>
      },
      "资金存入"->
      {
          <|
              "错误条件"-> "@fundeffect<=0",
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect!=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>
      },
      "资金取出"->
      {
          <|
              "错误条件"-> "@fundeffect>=0",
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect!=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>
      },
      "资金调整"->
      {
          <|
              "错误条件"-> "@fundeffect=0",
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect!=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>
      },
      "红股入账"->
      {
          <|
              "错误条件"-> "@fundeffect!=0",
              "错误信息"-> "资金发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@stkeffect<=0",
              "错误信息"-> "股份发生与该业务不符."
          |>,
          <|
              "错误条件"-> "@matchqty!=@stkeffect",
              "错误信息"-> "成交数量不等于股份发生."
          |>,
          <|
              "错误条件"-> "@fee_sxf!=0 or @fee_jsxf!=0 or @fee_ghf!=0 or @fee_yhs!=0 or @qtfee!=0",
              "错误信息"-> "费用金额异常."
          |>
      }
  |>
#+END_SRC


#+NAME: 核算配置
#+BEGIN_SRC
  [
      {
          "业务名称":  "证券买入",
          "存储过程":  "sp_Cust_PT_Buy",
          "业务摘要":  "220000",
          "流通类型":  "流通",
          "动作类型":  "0B",
          "产生方式":  "手工"
      },
      {
          "业务名称":  "配股权证",
          "存储过程":  "sp_Cust_PT_Pgqz",
          "业务摘要":  "221011",
          "流通类型":  "流通",
          "产生方式":  "模板 - 通用"
          "错误处理":  "配股权证"
      }
  ]
#+END_SRC

#+NAME: list:核算办法
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 业务名称         | 业务摘要 | 流通类型 | 转出类型 | 核算类型 | 校验                        | 进度 | 产生方式 | 核算要点                           |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 证券买入         |   220000 |       00 |       00 | 证券买入 | 普通买入                    | 完成 | 模板     |                                    |
| Tn证券买入       |   220100 |       00 |       00 | 证券买入 | 普通买入                    | 完成 | 模板     |                                    |
| 沪港通股票买入   |   220094 |       00 |       00 | 证券买入 | 普通买入                    | 完成 | 模板     |                                    |
| 开放基金申购     |   220049 |       00 |       00 | 基金买入 | 普通买入                    | 完成 | 模板     |                                    |
| 专户基金申购     |   220090 |       00 |       00 | 基金买入 | 普通买入                    | 完成 | 模板     |                                    |
| 担保品买入       |   550001 |       00 |       00 | 证券买入 | 普通买入                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 新股申购         |   220023 |       03 |       03 | 新股申购 | 普通买入（价格=matchprice） | 完成 | 模板     |                                    |
| 申购还款         |   221024 |       03 |       03 | 申购还款 | -                           | 完成 | 模板     |                                    |
| 申购中签         |   220027 |       01 |       01 | 申购中签 | 申购中签                    | 完成 | 模板     |                                    |
| 新股入帐         |   220004 |       00 |       01 | 正股入账 | -                           | 完成 | 模板     | 非流通正股转入流通状态             |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 配股权证         |   221011 |       02 |       02 | 持仓上账 | 持仓上账                    | 完成 | 模板     |                                    |
| 配股缴款         |   220012 |       01 |       02 | 行权扣款 | 行权缴款（fee=0）           | 完成 | 模板     |                                    |
| 配股入帐         |   221013 |       00 |       01 | 正股入账 | -                           | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 配售缴款         |   220031 |       01 |       01 | 申购中签 | 行权缴款（fee=0）           | 完成 | 模板     |                                    |
| 配售股份         |   220030 |       00 |       01 | 正股入账 | -                           | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 港股通送股上市   |   220114 |       00 |       01 | 送股上市 | 持仓上账                    | 完成 | 模板     |                                    |
| 港股通非交易出   |   220116 |       00 |       00 | 非交易出 | 持仓下账                    | 完成 | 模板     |                                    |
| 港股通非交易入   |   220115 |       00 |       00 | 非交易入 | 持仓上账                    | 完成 | 模板     |                                    |
| 沪港通供股       |   220121 |       01 |       01 | 供股缴款 | 行权缴款（fee=0）           | 完成 | 模板     |                                    |
| 沪港通公司收购   |   220109 |       00 |       00 | 公司收购 | -                           | -    | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 自主行权扣款     |   220058 |       01 |       00 | 行权扣款 | 行权缴款                    | -    | 模板     |                                    |
| 自主行权增股     |   220059 |       00 |       01 | 正股入账 | -                           | -    | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 证券卖出         |   221001 |       00 |       00 | 证券卖出 | 普通卖出                    | 完成 | 模板     |                                    |
| Tn证券卖出       |   221101 |       00 |       00 | 证券卖出 | 普通卖出                    | 完成 | 模板     |                                    |
| 沪港通股票卖出   |   220095 |       00 |       00 | 证券卖出 | 普通卖出                    | 完成 | 模板     |                                    |
| 沪港通权证卖出   |   220099 |       00 |       00 | 证券卖出 | 普通卖出                    | 完成 | 模板     |                                    |
| 开放基金赎回     |   221049 |       00 |       00 | 基金卖出 | 普通卖出                    | 完成 | 模板     |                                    |
| 专户基金赎回     |   220091 |       00 |       00 | 基金卖出 | 普通卖出                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 融资回购         |   221002 |       06 |       06 | 融资回购 | 融资回购（价格=100）        | 完成 | 模板     | 成本计增，但注意汇总时需扣除。     |
| 约定融资回购     |   221004 |       16 |       16 | 融资回购 | 融资回购                    | 完成 | 模板     | 计增借入金额                       |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 融资购回         |   220034 |       06 |       06 | 融资购回 | 融券回购                    | 完成 | 模板     | 成本和借入金额分别按购回比例计减。 |
| 约定融资购回     |   220043 |       16 |       16 | 融资购回 | 融券回购                    | 完成 | 模板     | 价差损失计减利息收入。             |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 融券回购         |   220003 |       07 |       07 | 融券回购 | 融券回购（价格=100）        | 完成 | 模板     | 成本计增，类似于买入               |
| 报价融券回购     |   220006 |       27 |       27 | 融券回购 | 融券回购（价格=100）        | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 融券购回         |   221035 |       07 |       07 | 融券购回 | 融资回购                    | 完成 | 模板     | 成本和借出金额分别按购回比例计减   |
| 报价融券购回     |   221033 |       27 |       27 | 融券购回 | 融资回购                    | 完成 | 模板     | 价差收益计增利息收入。             |
| 报价融券提前购回 |   221034 |       27 |       27 | 融券购回 | 融资回购                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 质押出库         |   220060 |       00 |       00 | 质押出库 | 持仓上账                    | 完成 | 模板     |                                    |
| 报价出库         |   220067 |       00 |       00 | 质押出库 | ?                           | -    | 模板     |                                    |
| 质押入库         |   221060 |       00 |       00 | 质押入库 | 持仓下账                    | 完成 | 模板     |                                    |
| 报价入库         |   221067 |       00 |       00 | 质押入库 | ?                           | -    | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 指定入帐         |   220016 |       00 |       00 | 证券转入 | 持仓上账                    | 完成 | 模板     |                                    |
| 转托管入         |   220015 |       00 |       00 | 证券转入 | 持仓上账                    | 完成 | 模板     |                                    |
| 港股通指定交易   |   220118 |       00 |       00 | 证券转入 | 持仓上账                    | 完成 | 模板     |                                    |
| 股份转入         |   220005 |       00 |       00 | ?        | ?                           | -    | ?        |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 撤指转出         |   221032 |       00 |       00 | 证券转出 | 持仓下账                    | 完成 | 模板     |                                    |
| 转托管出         |   221014 |       00 |       00 | 证券转出 | 持仓下账                    | 完成 | 模板     |                                    |
| 股份转出         |   221006 |       00 |       00 | ?        | ?                           | -    | ?        |                                    |
| 港股通撤指交易   |   220119 |       00 |       00 | 证券转出 | 持仓下账                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 红利入账         |   221007 |       00 |       00 | 红利入账 | 资金存入                    | 完成 | 模板     |                                    |
| 沪港通红利发放   |   220096 |       00 |       00 | 红利入账 | 资金存入                    | 完成 | 模板     |                                    |
| 基金红利拨入     |   240507 |       00 |       00 | 红利入账 | 资金存入                    | -    | 模板     |                                    |
| 红利认领         |   150032 |       00 |       00 | 红利入账 | 资金存入                    | 完成 | 模板     |                                    |
| 债券兑息         |   221008 |       00 |       00 | 红利入账 | 资金存入                    | 完成 | 模板     |                                    |
| 沪港通零股现金   |   220108 |       00 |       00 | 红利入账 | 资金存入                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 红股入账         |   220010 |       00 |       00 | 红股入账 | 红股入账                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 利息归本         |   140011 |       00 |       00 | 资金结息 | 资金存入                    | 完成 | 模板     |                                    |
| 罚息归本         |   140032 |       00 |       00 | 资金结息 | 资金存入                    | -    | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 债券兑付         |   221009 |       00 |       00 | 债券兑付 | -                           | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 查询收费         |   222006 |       00 |       00 | 综合费用 | 费用（校验和）              | 完成 | 模板     |                                    |
| 沪港通组合费     |   220097 |       00 |       00 | 综合费用 | 费用（校验和）              | 完成 | 模板     |                                    |
| 转托管费         |   222003 |       00 |       00 | 综合费用 | 费用（校验和）              | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 自主行权提交所得 |   580509 |       00 |       00 | 其它费用 | 资金取出                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 限售股转让扣税   |   221042 |       00 |       00 | 利息扣税 | 费用（校验和）              | 完成 | 模板     |                                    |
| 股息红利差异扣税 |   140203 |       00 |       00 | 利息扣税 | 资金取出                    | 完成 | 模板     |                                    |
| 股息红利扣税蓝补 |   140205 |       00 |       00 | 利息扣税 | 资金存入                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 约定融券回购     |   220007 |       17 |       17 | 无需核算 | -                           | 完成 | 模板     | 计增借出金额                       |
| 约定融券购回     |   221043 |       17 |       17 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 报价融资提前购回 |   221023 |       06 |       06 | 无需核算 | -                           | 完成 | 模板     | 只更新流水表的核算状态             |
| 报价融资回购     |   221003 |       06 |       06 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 报价融资购回     |   220035 |       06 |       06 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 指定交易         |   220032 |       00 |       00 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 撤销指定         |   220033 |       00 |       00 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 投票确认         |   222004 |       00 |       00 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 国债预发额度注册 |   221350 |       00 |       00 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 国债预发额度注销 |   221351 |       00 |       00 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 开放基金合并增股 |   220057 |       00 |       00 | 无需核算 | -                           | 完成 | 模板     |                                    |
| 开放基金拆分减股 |   221057 |       00 |       00 | 无需核算 | -                           | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 三方存管现金蓝补 |   940008 |       00 |       00 | 资金调整 | 资金调整                    | 完成 | 模板     | 调整资金余额                       |
| 三方存管现金红冲 |   940029 |       00 |       00 | 资金调整 | 资金调整                    | 完成 | 模板     |                                    |
| 现金蓝补         |   140008 |       00 |       00 | 资金调整 | 资金调整                    | 完成 | 模板     |                                    |
| 现金红冲         |   140029 |       00 |       00 | 资金调整 | 资金调整                    | 完成 | 模板     |                                    |
| 支票蓝补         |   140009 |       00 |       00 | 资金调整 | 资金调整                    | -    | 模板     |                                    |
| 支票红冲         |   140030 |       00 |       00 | 资金调整 | 资金调整                    | -    | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 开放基金拆分增股 |   220056 |       00 |       00 | 基金拆分 | 持仓上账                    | 完成 | 模板     |                                    |
| 开放基金合并减股 |   221056 |       00 |       00 | 基金合并 | 持仓下账                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 基金上折         |   220137 |       00 |       00 | 持仓上账 | 持仓上账                    | 完成 | 模板     |                                    |
| 股份认领         |   150030 |       00 |       00 | 持仓上账 | 股份认领                    | 完成 | 模板     |                                    |
| 证券蓝补         |   150002 |       00 |       00 | 持仓上账 | 持仓上账                    | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 基金下折         |   220138 |       00 |       00 | 持仓下账 | 持仓下账                    | 完成 | 模板     |                                    |
| 删除过期证券     |   110434 |       00 |       00 | 持仓下账 | 持仓下账（matchqty=0）      | 完成 | 模板     |                                    |
| 证券红冲         |   150001 |       00 |       00 | 持仓下账 | 持仓下账（matchqty=0）      | 完成 | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 银行转证券       |   160021 |       00 |       00 | 资金存入 | 资金存入                    | 完成 | 模板     |                                    |
| 冲正银行转证券   |   160023 |       00 |       00 | ?        | ?                           | -    | ?        |                                    |
| 存折存           |   140002 |       00 |       00 | 资金存入 | 资金存入                    | 完成 | 模板     |                                    |
| 现金存           |   140001 |       00 |       00 | 资金存入 | 资金存入                    | 完成 | 模板     |                                    |
| 银证转帐调帐存   |   160031 |       00 |       00 | 资金存入 | 资金存入                    | 完成 | 模板     |                                    |
| 转帐支票存       |   140004 |       00 |       00 | 资金存入 | 资金存入                    | -    | 模板     |                                    |
| OCT资金划入      |   140211 |       00 |       00 | 资金存入 | 资金存入                    | 完成 | 模板     |                                    |
| 调帐转帐转入     |   168007 |       00 |       00 | 资金存入 | 资金存入                    | 完成 | 模板     |                                    |
| 台帐间现金划转存 |   140055 |       00 |       00 | 资金存入 | 资金存入                    | 完成 | 模板     |                                    |
| 转账支票确认     |   140202 |       00 |       00 | 资金存入 | 资金存入                    | -    | 模板     |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|
| 证券转银行       |   160022 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 冲正证券转银行   |   160024 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 存折取           |   140022 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 现金取           |   140021 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 转帐支票取       |   140024 |       00 |       00 | 资金取出 | 资金取出                    | -    | 模板     |                                    |
| OCT资金划出      |   140212 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 调帐转帐转出     |   168008 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 银证转帐调帐取   |   160032 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 台帐间现金划转取 |   140057 |       00 |       00 | 资金取出 | 资金取出                    | 完成 | 模板     |                                    |
| 冲转帐支票取     |   140124 |       00 |       00 | 资金取出 | 资金取出                    | -    | 模板     |                                    |
| 保险资金划出     |   140502 |       00 |       00 | ?        | ?                           | -    | ?        |                                    |
|------------------+----------+----------+----------+----------+-----------------------------+------+----------+------------------------------------|


新股

*** 无需核算

- 指定交易（220032）
  - 指定交易是指投资者可以指定某一证券营业部为自己买卖证券的唯一的交易营业部。
  - 买入代码为“799999”的股票。
- 撤销指定（220033）
- 港股通指定交易（220118）
  - 内地投资者参与港股通交易，适用目前上交所关于指定交易的相关规定，实行全面指定交易制度。
- 港股通撤指交易（220119）
- 删除过期证券（110434）
  - 删除过期证券时客户已经没有持仓。
- 投票确认（222004）
  - 客户用特殊的买入证券信息代表投票意向。
- 报价融资回购（221003）
  - 报价回购CSC方不参与核算
- 报价融资购回（220035）
- 报价融资提前购回（221023）
- 国债预发额度注册（221350）
- 国债预发额度注销（221351）

**** OPEN 港股通指定、撤指包含股份发生数？

*** 资金调整

#+NAME: acc:会计分录
|----------+----------+----------+-------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额              | 说明         |
|----------+----------+----------+-------------------+--------------|
| 资金调整 | 账户资金 | 表外对拆 | 业务流水.资金发生 | 资金调整入账 |
|----------+----------+----------+-------------------+--------------|

- 三方存管现金蓝补（940008）
- 三方存管现金红冲（940029）
- 现金红冲（140029）
- 现金蓝补（140008）
- 支票蓝补（140009）
- 支票红冲（140030）
- 三方存管加银行+（940012）
  - “第三方存管”是指证券公司客户证券交易结算资金交由银行存管，由存管银行按照法律、法规的要求，负责客户资金的存取与资金交收，证券交易操作保持不变。 
- 三方存管加银行-（940013）
- 三方存管减银行-（940010）
- 三方存管减银行+（940011）

*** 持仓调整

用于调整持仓数量，持仓成本不变。

#+NAME: acc:会计分录
|----------+----------+----------+--------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额               | 说明         |
|----------+----------+----------+--------------------+--------------|
| 持仓调整 | 表外对拆 | 持仓数量 | -业务流水.股份发生 | 持仓调整记录 |
|----------+----------+----------+--------------------+--------------|

- 证券红冲（150001）
- 证券蓝补（150002）
- 基金上折（220137）
  - 基金公司通过上折和下折调整基金净值。产生的份额变动，总资产不变。
- 基金下折（220138）
- 开放基金拆分增股（220056）
- 开放基金合并减股（221056）
- 开放基金拆分减股（221057）
- 开放基金合并增股（220057）

*** 利息扣税

持有股票遇到分红派息的时候，会根据持有期限的长短收取适当的红利税。持股时间越长税率越低。

#+NAME: acc:会计分录
|----------+----------+----------+--------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额               | 说明         |
|----------+----------+----------+--------------------+--------------|
| 利息扣税 | 利息税费 | 账户资金 | -业务流水.资金发生 | 利息扣税入账 |
|----------+----------+----------+--------------------+--------------|

- 股息红利差异扣税（140203）
- 股息红利扣税蓝补（140205）

*** 资金存入

#+NAME: acc:会计分录
|----------+----------+----------+-------------------+----------|
| 核算类型 | 借方     | 贷方     | 金额              | 说明     |
|----------+----------+----------+-------------------+----------|
| 资金存入 | 账户资金 | 存款金额 | 业务流水.资金发生 | 存款入账 |
|----------+----------+----------+-------------------+----------|

- 存折存（140002）
- 现金存（140001）
- 银行转证券（160021）
- 银证转帐调帐存（160031）
- 转帐支票存（140004）
- OTC资金划入（140211）
- 调帐转帐转入（168007）
- 台帐间现金划转存（140055）
  - 金额从一个银行账户划转到另一个银行账户，取存同时发生。
- 转账支票确认（140202）

*** 资金取出

#+NAME: acc:会计分录
|----------+----------+----------+--------------------+----------|
| 核算类型 | 借方     | 贷方     | 金额               | 说明     |
|----------+----------+----------+--------------------+----------|
| 资金取出 | 取款金额 | 账户资金 | -业务流水.资金发生 | 取款入账 |
|----------+----------+----------+--------------------+----------|


- 存折取（140022）
- 现金取（140021）
- 证券转银行（160022）
- 冲正证券转银行（160024）
  - 此为“证券转银行”的反冲操作
- 转帐支票取（140024）
- OTC资金划出（140212）
- 调帐转帐转出（168008）
- 银证转帐调帐取（160032）
- 台帐间现金划转取（140057）
- 冲转帐支票取（140124）
  - 此为“转账支票取”的反冲操作

*** 其它费用

#+NAME: acc:会计分录
|----------+----------+----------+--------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额               | 说明         |
|----------+----------+----------+--------------------+--------------|
| 其它费用 | 其它费用 | 账户资金 | -业务流水.资金发生 | 其它费用入账 |
|----------+----------+----------+--------------------+--------------|


- 查询收费（222006）
  - 前台费入其它费用
- 沪港通组合费（220097）
  - 证券组合费最终由香港结算按持有市值的不同档次按日收取
- 转托管费（222003）
- 限售股转让扣税（221042）
- 自主行权提交所得（580509）

*** 质押出入

调整“质押数量”stkpledge.

- 质押出库（220060）
- 质押入库（221060）


*** 证券买入

#+NAME: acc:会计分录
|----------+----------+----------+----------+--------------------------|
| 核算类型 | 借方     | 贷方     | 金额     | 说明                     |
|----------+----------+----------+----------+--------------------------|
| 证券买入 | 持仓成本 | 账户资金 | 成交金额 | 成本入账                 |
| 证券买入 | 其它费用 | 账户资金 | 手续费   | 手续费入账               |
| 证券买入 | 净手续费 | 其它费用 | 券商佣金 | 净手续费（券商佣金）入账 |
| 证券买入 | 过户费用 | 其它费用 | 过户费   | 过户费入账               |
|----------+----------+----------+----------+--------------------------|
| 证券买入 | 表外对拆 | 买入金额 | 成交金额 | 买入金额记录             |
| 证券买入 | 持仓数量 | 买入数量 | 成交数量 | 买入数量记录             |
|----------+----------+----------+----------+--------------------------|

- 证券买入（220000）
  - 成交金额影响成本
  - 不影响投资收益
  - 费用处理：先把总费用（手续费）计入其它费用，再从其它费用中扣除过户费和券商佣金（净手续费）
- Tn证券买入（220100）
- 沪港通股票买入（220094）
- 沪港通供股（220121）
  - 供股即公司向所有股东融资，扩大股本，可以选择行权，也可以放弃。
  - 是一种配股，但是缴费与股票到账同步完成。按照证券买入进行核算。
- 约定融资购回（220043）
- 约定融券回购（220007）
- 担保品买入（550001）

*** 配股权证

#+NAME: acc:会计分录
|----------+----------+----------+----------+------------------|
| 核算类型 | 借方     | 贷方     | 金额     | 说明             |
|----------+----------+----------+----------+------------------|
| 配股权证 | 持仓数量 | 表外对拆 | 成交数量 | 配股权证数量记录 |
|----------+----------+----------+----------+------------------|

- 配股权证（221011）
  - 配股权证是上市公司给予其老股东的一种认购该公司股份的权利证明。上市公司在实施配股时，会按配股比例向股东发放配股权证。
  - 配股权证的获得没有成本和费用。核算仅在表外记录一笔数量。

*** 行权缴款

- 冲销权证的表外记录。
- 相当于买入使用正股代码，流通类型核算缴款金额，用“调整金额”挂账，等到证券交收的时候“调整金额”转入持仓成本。
- 费用核算同证券买入。

#+NAME: acc:会计分录
|----------+----------+----------+----------+--------------------------|
| 核算类型 | 借方     | 贷方     | 金额     | 说明                     |
|----------+----------+----------+----------+--------------------------|
| 行权缴款 | 调整金额 | 账户资金 | 成交金额 | 正股缴款入账             |
| 行权缴款 | 其它费用 | 账户资金 | 手续费   | 手续费入账               |
| 行权缴款 | 净手续费 | 其它费用 | 券商佣金 | 净手续费（券商佣金）入账 |
| 行权缴款 | 过户费用 | 其它费用 | 过户费   | 过户费入账               |
|----------+----------+----------+----------+--------------------------|
| 行权缴款 | 表外对拆 | 持仓数量 | 成交数量 | 冲销权证数量记录         |
|----------+----------+----------+----------+--------------------------|

- 配股缴款（220012）
- 自主行权扣款（220058）
- 配售缴款（220031）
  - 配售是属于新股发行时的一种发行形式。新股发行时上市公司拿出总发行量中一定比例的股份在网下配售给一些机构投资者。在发行期间配售股个人投资者是买不到的。
  - 配售缴款和配售股份交收相当于把普通证券买入分两步走。缴款日资金减少，交收日证券增加。中间用“调整金额”挂账。

*** 证券交收

#+NAME: acc:会计分录
|----------+----------+----------+-------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额              | 说明         |
|----------+----------+----------+-------------------+--------------|
| 证券交收 | 持仓成本 | 调整金额 | 持仓核算.调整金额 | 交收成本入账 |
|----------+----------+----------+-------------------+--------------|
| 证券交收 | 持仓数量 | 表外对拆 | 成交数量          | 交收数量记录 |
|----------+----------+----------+-------------------+--------------|

- 配股入帐（221013）
- 自主行权增股（220059）
- 配售股份（220030）

*** 证券卖出

约定式融资（融券）回购（购回），是指客户利用已有股票以约定价格卖出给证券公司，约定在将来时期以约定价格执行购回的一种交易方式。核算按照普通的买入、卖出处理。

#+NAME: acc:会计分录
|----------+----------+----------+-----------------------------------------------------------+--------------------------|
| 核算类型 | 借方     | 贷方     | 金额                                                      | 说明                     |
|----------+----------+----------+-----------------------------------------------------------+--------------------------|
| 证券卖出 | 账户资金 | 交易收益 | 业务流水.成交金额                                         | 成本和交易收益入账       |
| 证券卖出 | 交易收益 | 持仓成本 | 持仓核算.持仓成本 * 业务流水.成交数量 / 持仓核算.持仓数量 | 成本和交易收益入账       |
| 证券卖出 | 其它费用 | 账户资金 | 业务流水.手续费                                           | 手续费入账               |
| 证券卖出 | 印花税费 | 其它费用 | 业务流水.印花税                                           | 印花税入账               |
| 证券卖出 | 净手续费 | 其它费用 | 业务流水.券商佣金                                         | 净手续费（券商佣金）入账 |
|----------+----------+----------+-----------------------------------------------------------+--------------------------|
| 证券卖出 | 卖出数量 | 持仓数量 | 业务流水.成交数量                                         | 卖出数量记录             |
| 证券卖出 | 卖出金额 | 表外对拆 | 业务流水.成交金额                                         | 卖出金额记录             |
|----------+----------+----------+-----------------------------------------------------------+--------------------------|

- 证券卖出（221001）
  - 成交数量按照平均价格影响成本
  - 卖出价格和平均持仓价格之差乘以卖出数量为投资收益（可正可负）
  - 应检查卖出数量在可允许范围之内
- Tn证券卖出（221101）
- 沪港通股票卖出（220095）
- 沪港通权证卖出（220099）
  - 由于权证的取得没有成本，卖出所得皆核算为交易收益。
- 约定融资回购（221004）
- 约定融券购回（221043）

*** 红股红利

#+NAME: acc:会计分录
|----------+----------+----------+-------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额              | 说明         |
|----------+----------+----------+-------------------+--------------|
| 红股红利 | 账户资金 | 利息收入 | 业务流水.资金发生 | 红利收入入账 |
|----------+----------+----------+-------------------+--------------|
| 红股红利 | 持仓数量 | 红股数量 | 业务流水.成交数量 | 红股数量记录 |
|----------+----------+----------+-------------------+--------------|

- 红股入账（220010）
  - 只有成交数量，增加持仓数量但不影响成本（红股价格为零）
  - 表外记录红股数量
  - 不影响资金
  - 无费用处理
- 红利入账（221007）
  - 成交金额入利息收入
  - 无费用处理
- 沪港通红利发放（220096）
- 红利认领（150032）
- 基金红利拨入（240507）
  - 遇到红利再投资，则按红股方式处理
- 债券兑息（221008）
  - 可从证券代码区分股票分红和债券利息

*** 报价回购

- 每笔报价回购交易会产生两笔业务：CSC角度的报价融资回购和客户角度的报价融券回购。CSC端的报价融资业务不参加核算。
- 报价回购核算基本按照证券买入卖出类似处理，但是：
  - 流通类型为07融券
  - 买卖价差放入利息收入

质押式报价回购交易，是指证券公司将符合要求的自有资产作为质押物，以质押物折算后的标准券数量所对应金额作为融资的额度，通过报价方式向证券公司符合条件的客户融入资金，同时约定证券公司在回购到期时向客户返还融入资金、支付相应收益的交易。该交易的质押物可以为符合深交所债券质押式回购交易相关规定的债券、基金份额、深交所和中国结算认可的其他证券、现金，品种期限可以为1天至365天。

报价回购业务是证券公司推出的类似银行理财产品的一种投资工具。比如客户在证券公司进行申购新股，可以利用资金解冻的到下次申购的档期直接进行报价回购业务操作，使资金利用率达到最高。

- 报价融券回购（220006）

*** 报价购回

- 报价融券购回（221033） 
- 报价融券提前购回（221034）     

*** 证券申购

#+NAME: acc:会计分录
|----------+--------------+----------+-------------------+--------------|
| 核算类型 | 借方         | 贷方     | 金额              | 说明         |
|----------+--------------+----------+-------------------+--------------|
| 证券申购 | 其它买入金额 | 账户资金 | 业务流水.资金发生 | 申购金额入账 |
| 证券申购 | DUMMY        | 申购数量 | 业务流水.股份发生 | 申购数量记录 |
|----------+--------------+----------+-------------------+--------------|


- 开放基金申购（220049）
- 专户基金申购（220090）
- 新股申购（220023）
- 申购还款（221024）
  - 反冲“新股申购”分录

*** 证券赎回

- 开放基金赎回（221049）
- 专户基金赎回（220091）

*** 资金结息

#+NAME: acc:会计分录
|----------+----------+----------+-------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额              | 说明         |
|----------+----------+----------+-------------------+--------------|
| 资金结息 | 账户资金 | 累计结息 | 业务流水.资金发生 | 累计结息入账 |
|----------+----------+----------+-------------------+--------------|

- 利息归本（140011）
  - 利息归本是指个人投资者存在证券交易账户内的资金所孳生的利息，证券公司按银行同期活期利率计算利息付给投资者，每个季度结算一次。
- 罚息归本（140032）


*** 债券兑付

- 债券兑付（221009）

- 债券兑付的两种方法：
  - 减少持仓：特征是成交数量 > 0。核算处理视为卖出。金额超出成交数量*成交价格（100）的部分为利息收入。
  - 降低票面价格：特征是成交数量 = 0。此时总金额中包含利息和还本，需要用到递减率指明其中的还本数量。

若为还份数情况：

|----------+----------+----------+--------------------------------+------------------|
| 核算类型 | 借方     | 贷方     | 金额                           | 说明             |
|----------+----------+----------+--------------------------------+------------------|
| 持仓兑付 | 资金余额 | 投资收益 | 成交金额                       | 兑付金额入账     |
| 持仓兑付 | 投资收益 | 持仓成本 | 持仓成本 * 成交数量 / 持仓数量 | 兑付持仓成本下账 |
| 持仓兑付 | 投资收益 | 利息收入 | 成交金额 - 成交数量 * 成交价格 | 兑付利息收入上账 |
|----------+----------+----------+--------------------------------+------------------|


- 资金余额 += 成交金额
- 投资收益 += 成交数量 * 成交价格 - 持仓成本 * 成交数量 / 持仓数量
- 持仓成本 -= 持仓成本 * 成交数量 / 持仓数量
- 利息收入 += 成交金额 - 成交数量 * 成交价格
- 持仓数量 -= 成交数量

若为降低票面价格情况：

|----------+----------+----------+------------------------------------+------------------|
| 核算类型 | 借方     | 贷方     | 金额                               | 说明             |
|----------+----------+----------+------------------------------------+------------------|
| 面额兑付 | 资金余额 | 投资收益 | 成交金额                           | 兑付金额入账     |
| 面额兑付 | 投资收益 | 持仓成本 | 持仓成本 * 递减率                  | 兑付持仓成本下账 |
| 面额兑付 | 投资收益 | 利息收入 | 成交金额 - 100 * 持仓数量 * 递减率 | 兑付利息收入上账 |
|----------+----------+----------+------------------------------------+------------------|

- 资金余额 += 成交金额
- 投资收益 += (100 * 持仓数量 - 持仓成本) * 递减率
- 持仓成本 -= 持仓成本 * 递减率
- 利息收入 += 成交金额 - 100 * 持仓数量 * 递减率
- 持仓数量：不变




*** 基金业务

基金认购拨出（240508）    
基金申购拨出（240509）
定时定额申购拨出（240510）
基金赎回拨入（240511）
基金强行赎回拨入（240512）
基金认购失败拨入（240513）
基金申购失败拨入（240514）
定时定额失败拨入（240515）

**** 基金交易资金划入（240516）


**** 基金资金拨出（240502）


**** 基金清盘资金拨入（240521）


**** 开放基金强行赎回（221050）


**** 开放基金认购（220050）


**** 开放基金认购入帐（220051）


**** 开放基金认购退款（220054）




*** 融资业务

融资业务的会计处理，证券公司将资金借给客户，与银行贷款业务并无本质区别，因此客户根据银行贷款的业务做相似的会计处理即可。


**** 偿还融资负债本金（552017）


**** 偿还融资利息（552001）


**** 融资买入（550002）

- 用融资借入的资金买入证券。
- 核算依照核算类型“证券买入”进行。


**** 卖券还款（550003）


- 用融资借入的资金买入证券。
- 核算依照核算类型“证券买入”进行。

#+NAME: acc:会计分录
|----------+----------+----------+-----------------------------------------------------------+--------------------------|
| 核算类型 | 借方     | 贷方     | 金额                                                      | 说明                     |
|----------+----------+----------+-----------------------------------------------------------+--------------------------|
| 卖券还款 | 账户资金 | 交易收益 | 业务流水.成交金额                                         | 成本和交易收益入账       |
| 卖券还款 | 借入金额 | 账户资金 | 业务流水.成交金额                                         | 偿还借款                 |
| 卖券还款 | 交易收益 | 持仓成本 | 持仓核算.持仓成本 * 业务流水.成交数量 / 持仓核算.持仓数量 | 成本和交易收益入账       |
| 卖券还款 | 其它费用 | 账户资金 | 业务流水.手续费                                           | 手续费入账               |
| 卖券还款 | 印花税费 | 其它费用 | 业务流水.印花税                                           | 印花税入账               |
| 卖券还款 | 净手续费 | 其它费用 | 业务流水.券商佣金                                         | 净手续费（券商佣金）入账 |
|----------+----------+----------+-----------------------------------------------------------+--------------------------|
| 卖券还款 | 卖出数量 | 持仓数量 | 业务流水.成交数量                                         | 卖出数量记录             |
| 卖券还款 | 卖出金额 | 表外对拆 | 业务流水.成交金额                                         | 卖出金额记录             |
|----------+----------+----------+-----------------------------------------------------------+--------------------------|

(case when 借入金额 > 业务流水.成交金额, 业务流水.成交金额, 借入金额)


**** 融资购回（220034）


**** 融资回购（221002）


**** 融资借入（553001）


**** 融资借出（553002）


**** 偿还融资头寸全额（552034）


**** 偿还融资逾债罚息（552012）


**** 偿还融资逾期利息（552006）


**** 偿还融资逾利罚息（552011）


**** 融资平仓（550004）


**** 偿还融资管理费（552002）



**** 担保品卖出（550005）


     
*** 融券业务

[[http://www.cnnsr.com.cn/jtym/swk/20110701/2011070109472365943.shtml][融资融券业务的会计处理]]

融券业务的会计处理，客户借入证券应确认“交易性金融资产”，同时因为承担金融负债的目的，主要是为了近期内回购，因此在出售该证券期间可以相对应地确认“交易性金融负债”，用以反映企业因证券价格浮动而带来负债金额的变动。

**** 股票质押融资购回（221243）
**** 融券借入（553003）
**** 融券卖出（550006）
**** 买券还券（550007）
**** 还券划出（551007）
**** 偿还融券负债（552018）
**** 偿还融券费用（552003）

#+NAME: acc:会计分录
|----------+----------+----------+--------------------+--------------|
| 核算类型 | 借方     | 贷方     | 金额               | 说明         |
|----------+----------+----------+--------------------+--------------|
| 融券利息 | 融券利息 | 账户资金 | -业务流水.资金发生 | 融券利息入账 |
|----------+----------+----------+--------------------+--------------|


**** 融券平仓（550008）
**** 偿还融券头寸全额（552037）
**** 偿还融券权益金额（552008）
**** 偿还融券特殊占用（552030）



**** 融券购回（221035）
**** 融券回购（220003）

**** 股票质押融券购回（221343）
**** 股票质押初始融券（221207）
**** 还转融通证券本券（550122）
**** 收转融通证券本券（550121）
**** 偿还融券逾期费用（552009）
**** 偿还融券逾费罚息（552015）
**** 偿还融券逾债罚息（552016）
**** 券源划出（551006）
**** 融券借出（553004）

     
*** 其它


**** ETF 赎回增股（220039）
**** ETF 申购减股（221036）
**** ETF 现金替代返款（221040）
**** ETF 现金替代扣款（220041）
**** ETF 申购退款（221038）
**** ETF 基金赎回（221037）
**** ETF 基金申购（220038）
**** ETF 现金差额返款（221039）
**** ETF 现金差额扣款（220042）
**** ETF 赎回收费（220048）
**** ETF 申购收费（220047）
**** ETF 申购补扣（220040）
**** LOF认购（220024）
**** 上证LOF赎回（220085）
**** 上证LOF确认返款（220136）
**** 上证LOF确认扣款（220135）
**** 上证LOF申购（220084）
**** 股份转出（221006）
**** 担保物转入（551001）
**** 担保物转出（551005）

**** 股票质押初始融资（221204）

**** 股票质押借方部分（221253）

**** 配股退款退息（221012）
**** 股票质押借方补质（221251）
**** 股票质押利息扣收（140200）
**** 股票质押利息偿还（141106）

**** 金融认购拨出（260508）
**** 撤指转出（221032）
**** 金融强行赎回拨入（260512）
**** 指定入帐（220016）
**** 转托管出（221014）
**** 转托管入（220015）
**** 债券转股回售转出（221017）
**** 转股入帐（220018）
**** 转股零款（221031）
**** 证券分拆记增/基（551021）
**** 证券分拆记减/基（551020）
**** 余券转入（551004）
**** 余券转出（551008）
**** 还券转余券（554007）
**** 内部转托管出（150028）
**** 转融通出借归还（221091）
**** 转融通出借利息（221092）
**** 快速过户拨入（240562）
**** 偿还融资头寸空闲（552036）
**** 转融通出借证券（221090）


**** 券源划入（551002）
**** 要约资金（221022）
**** 债券回售赎回资金（221019）
**** 要约确认（220020）
**** 要约解除（221021）


**** 转融通出借权益（221095）
**** 预发行卖资金清算（221357）
**** 预发行买资金清算（221356）
**** 国债预发行客买入（221352）
**** 国债预发行客卖出（221353）
**** 还转融通权益补偿（550126）
**** 报价入库（221067）
**** 非公开优先股转出（220093）

**** 内部转托管出取消（150031）
**** 理财产品转让拨入（240523）
**** 理财产品转让拨出（240524）
**** 余券红利划入（554003）
**** 余券红利划出（554004）






select count(distinct (a.n, b.n, c.n, d.n)) result from
generate_series(1, ceil(2016^(1./4))) a(n),
generate_series(1, ceil(2016^(1./3))) b(n),
generate_series(1, ceil(2016^(1./2))) c(n),
generate_series(1, 2016) d(n)
where a.n * b.n * c.n * d.n = 2016 and
a.n <= b.n and
b.n <= c.n and
c.n <= d.n;







-----

custcal=# select distinct digestid from logasset_hs where stkcode is null and stkeffect = 0 and fundeffect < 0;
 digestid
----------
   222006
   940029
   160022
   220097
   140212
   140057
   168008
   

** 数据准备

|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 类型             | 节点     | 表名                              | 索引 | 完成情况   | 说明                                   |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 证券持仓表       | 节点1    | stkasset_jd1_20151231             | 有   | 完成       | 2015年底数据，按节点分表存放。         |
|                  | 节点2    | stkasset_jd2_20151231             | 有   | 完成       |                                        |
|                  | 节点3    | stkasset_jd3_20151231             | 有   | 完成       |                                        |
|                  | B股      | stkasset_bg_20151231              | 有   | 完成       |                                        |
|                  | 融资融券 | stkasset_rzrq_20151231            | 有   | 完成       |                                        |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 开放基金持仓表   | 节点1    | ofasset_jd1_20151231              | 无   | 完成       | 2015年底数据，按节点分表存放。         |
|                  | 节点2    | ofasset_jd2_20151231              | 无   | 完成       |                                        |
|                  | 节点3    | ofasset_jd3_20151231              | 无   | 完成       |                                        |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 资金表           | 节点1    | fundasset_jd1_20151231            | 有   | 完成       | 2015年底数据，按节点分表存放。         |
|                  | 节点2    | fundasset_jd2_20151231            | 有   | 完成       |                                        |
|                  | 节点3    | fundasset_jd3_20151231            | 有   | 完成       |                                        |
|                  | B股      | fundasset_bg_20151231             | 有   | 完成       |                                        |
|                  | 融资融券 | fundasset_rzrq_20151231           | 有   | 完成       |                                        |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 在途交收表       | 节点1    | uncommitclear_jd1_20151231        | 无   | 完成       | 2015年底数据，按节点分表存放。         |
|                  | 节点2    | uncommitclear_jd2_20151231        | 无   | 完成       |                                        |
|                  | 节点3    | uncommitclear_jd3_20151231        | 无   | 完成       |                                        |
|                  | B股      | uncommitclear_bg_20151231         | 无   | 完成       |                                        |
|                  | 融资融券 | uncommitclear_rzrq_20151231       | 无   | 完成       |                                        |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 证券流水信息     | 节点1    | logasset_jd1_2016_{01, 02 .. 10}  | 有   | 完成到10月 | 2016年以来数据，按节点、月份分表存放。 |
|                  | 节点2    | logasset_jd2_2016_{01, 02 .. 10}  | 有   | 完成到10月 |                                        |
|                  | 节点3    | logasset_jd3_2016_{01, 02 .. 10}  | 有   | 完成到7月  |                                        |
|                  | B股      | logasset_bg_2016_{01, 02 .. 10}   | 有   | 完成到10月 |                                        |
|                  | 融资融券 | logasset_rzrq_2016_{01, 02 .. 10} | 有   | 完成到10月 |                                        |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 开放基金流水信息 | 节点1    | oflogasset_jd1                    | 无   | 完成       | 2016年以来数据，按节点存放。           |
|                  | 节点2    | oflogasset_jd2                    | 无   | 完成       |                                        |
|                  | 节点3    | oflogasset_jd3                    | 无   | 完成       |                                        |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 市场数据         | 全节点   | stkprice_hs                       | 有   | 完成       | 2015年12月以来数据，含开放基金。       |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 正股代码连接     | 全节点   | stktrd                            | 有   | 完成       |                                        |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 除权除息信息     | 全节点   | gp_cqcx                           | 无   | 完成       | 含债券兑付部分还本比例等               |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|
| 存储过程信息     | 全节点   | digest_ext                        | 无   | 完成       | 业务摘要与存储过程的对应关系           |
|------------------+----------+-----------------------------------+------+------------+----------------------------------------|


