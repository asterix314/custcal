# 经纪业务核算接口设计


作为与其它系统的数据接口，经纪业务核算产出三张表：

- `stkasset_hs`：证券资产明细表，按客户号、节点、证券代码分别列示。
- `fundasset_hs`：现金资产明细表，按客户号、节点、资金账号、币种分别列示。
- `sumasset_hs`：客户资产汇总表，是以上两个表的汇总，按客户、业务类型、市场分别列示，无证券代码信息。

以上表格按月存储，如`sumasset_hs_2016_07`为2016年7月数据。

## 客户资产汇总表 `sumasset_hs`

字段| 类型     | 说明 
--|--|--
| `sysdate`     | int           | 核算日期。                                                         |
| `custid`      | bigint        | 客户号。聚合了同一客户下的各节点、资金账号、证券账号。             |
| `ltlx`        | varchar(2)  | 资产类别（中文）。如：股票买卖、报价回购等。                       |
| `market`      | char(1)       | 市场代码。                                                         |
| `moneytype`   | char(1)       | 币种代码。                                                         |
| `stkcost`     | numeric(20,2) | 证券持仓成本，含转融通出借的证券。                                 |
| `stkqty_tzje` | numeric(20,2) | 证券持仓成本调整，用于券款不同步时校正资产等情况。                 |
| `fundbal`     | numeric(20,2) | 资金资产。                                                         |
| `loan`        | numeric(20,2) | 金融债权资产。                                                     |
| `funduncome`  | numeric(20,2) | 在途未收资金。                                                     |
| `debt`        | numeric(20,2) | 金融负债：融资负债或空头仓等，或者融入的资金产生的债务。           |
| `fundunpay`   | numeric(20,2) | 在途未付资金。                                                     |
| `syvalue`     | numeric(20,2) | 交易收益：买卖价差损益（平均成本法），或资金的其它收入。           |
| `gyvalue`     | numeric(20,2) | 浮动盈亏：市值金额 - 持仓成本。                                    |
| `lxsr`        | numeric(20,2) | 股息收入：持仓的股票、债券派息收入。资金的活期利息收入。           |
| `jrzc`        | numeric(20,2) | 融入资券利息费用，回购，融资融券，转融通等。                       |
| `cjsr`        | numeric(20,2) | 融出资券利息收入，回购，融资融券，转融通等。                       |
| `jsxf`        | numeric(20,2) | 净手续费：建投佣金。                                               |
| `yhs`         | numeric(20,2) | 印花税。                                                           |
| `ghf`         | numeric(20,2) | 过户费。                                                           |
| `lxs`         | numeric(20,2) | 利息税。                                                           |
| `qtfee`       | numeric(20,2) | 其它费用。                                                         |
| `adjust_in`   | numeric(20,2) | 证券或资金资产转入、存入。                                         |
| `adjust_out`  | numeric(20,2) | 证券或资金资产转出、取出。                                         |
| `mktvalue`    | numeric(20,2) | 市场价值：一般等于 市场价格 * 持仓数量，若无市场价格则为持仓成本。 |
| `stkqty`      | numeric(20,2) | 持仓数量                                                           |
| `stkqty_tz`   | numeric(20,2) | 调整数量：用于券款不同步时校正持仓数量。                           |
| `stkpledge`   | numeric(20,2) | 质押数量。                                                         |
| `stkloan`     | numeric(20,2) | 出借数量（转融通）。                                               |
| `stkhgqty`    | numeric(20,2) | 红股数量。                                                         |
| `stkpgqty`    | numeric(20,2) | 配股数量。                                                         |
|               |               |                                                                    |


- 流通类型代码 `ltlx`

代码| 流通类型
--|--
| `00` | 二级市场流通     |
| `01` | 限售流通         |
| `02` | 配售权证         |
| `03` | 申购状态         |
| `05` | 融资融券         |
| `06` | 债券质押融资回购 |
| `07` | 债券质押融券回购 |
| `08` | OTC产品          |
| `09` | 贵金属现货       |
| `10` | 贵金属递延多头仓 |
| `11` | 贵金属递延空头仓 |
| `16` | 约定融资回购     |
| `17` | 约定融券回购     |
| `26` | 报价融资回购     |
| `27` | 报价融券回购     |
| `36` | 股票质押融资回购 |
| `37` | 股票质押融券回购 |
| `80` | 个股期权权利仓   |
| `81` | 个股期权义务仓   |
| `99` | 现金             |

- 市场代码 `market`

代码| 市场
--|--
 | `0` | 深A            |
 | `1` | 沪A            |
 | `2` | 深B            |
 | `3` | 沪B            |
 | `5` | 沪港通         |
 | `6` | 股转A          |
 | `7` | 股转B          |
 | `A` | 非交易所债券   |
 | `J` | 开放式基金     |
 | `K` | 开放式基金在途 |
 | `L` | 银行理财       |
 | `S` | 深港通         |
 | `P` | 强制赎回       |
 | `G` | 个股期权       |
 | `O` | OTC产品        |
 | `X` | 贵金属现货     |
 | `D` | 贵金属递延     |

- 货币代码 `moneytype`

代码| 货币
--|--
`0` | CNY
`1` | HKD
`2` | USD


## 客户持仓明细表 `stkasset_hs`

持仓头寸归集标准为：
  - 节点号、营业部号、客户号、市场、证券代码、流通类型。


| 变量名称         | 字段          | 说明                                                        |
|------------------|---------------|-------------------------------------------------------------|
| 节点号           | serverid      | 节点A：1-3，B股：7，融资融券：8                             |
| 营业部号         | orgid         | 对应业务流水相同字段                                        |
| 客户号           | custid        | 对应业务流水相同字段                                        |
| 资金帐号         | fundid        | 对应业务流水相同字段                                        |
| 市场             | market        | 0深A 1沪A 2深B 3沪B J基金 5沪港通 6股转 8融资融券 G个股期权 |
| 证券代码         | stkcode       | 对应业务流水相同字段                                        |
| 市场价格         | stkprice      | 市场数据表的收盘价                                          |
| 流通类型         | ltlx          | 说明 1)                                                     |
| 计提日期         | jtdate        | 说明 2)                                                     |
| 公允日期         | gydate        | ？                                                          |
| 备注             | remark        | 内容不做限制                                                |
| 买入数量         | stkbuyqty     | 二级市场买卖交易，统计客户交易量用                          |
| 买入金额         | stkbuyamt     |                                                             |
| 卖出数量         | stksaleqty    | 二级市场买卖交易，统计客户交易量用                          |
| 卖出金额         | stksaleamt    |                                                             |
| 申购数量         | stkbuyqty_ex  | 如LOF、ETF申购、基金认购等                                  |
| 其它买入金额     | stkbuyamt_ex  | 说明 3)                                                     |
| 赎回数量         | stksaleqty_ex | 如LOF、ETF赎回、基金赎回等                                  |
| 其它卖出金额     | stksaleamt_ex | 说明 3)                                                     |
| 转入数量         | stkztgrqty    | 说明 4)                                                     |
| 转入金额         | stkztgramt    | 说明 4)                                                     |
| 转出数量         | stkztgcqty    | 说明 4)                                                     |
| 转出金额         | stkztgcamt    | 说明 4)                                                     |
| 红股数量         | stkhgqty      | 红股价格视为零                                              |
| 红利金额         | stkhlamt      |                                                             |
| 配股数量         | stkpgqty      | 视为以配股价格购入                                          |
| 配股金额         | stkpgamt      |                                                             |
| 持仓数量         | stkqty        |                                                             |
| 调整数量         | stkqty_tz     | 说明 9)                                                     |
| 调整金额         | stkqty_tzje   | 说明 9)                                                     |
| 质押数量         | stkpledge     | 说明 5)                                                     |
| 借入数量         | stkdebt       | 说明 6)                                                    |
| 借出数量         | stkloan       | 说明 6)                                                     |
| 毛手续费         | sxf           |                                                             |
| 持仓成本         | stkcost       |                                                             |
| 外部转托金额     | stkadjust     | 说明 7)                                                     |
| 交易收益         | syvalue       | 核算买卖价差损益（平均成本法）                              |
| 浮动盈亏         | gyvalue       | 等于：市值金额 - 持仓成本                                   |
| 利息收入         | lxsr          | 说明 10)                                                    |
| 借出利息收入     | cjsr          | 出借资券业务的收入                                          |
| 借入利息费用     | jrzc          | 借入资券业务的支出，含质押式融资融券                        |
| 预计利息         | aiamount      |                                                             |
| 净手续费         | jsxf          | 即券商佣金                                                  |
| 印花税费         | yhs           |                                                             |
| 过户费用         | ghf           |                                                             |
| 其它费用         | qtfee         |                                                             |
| 利息税费         | lxs           |                                                             |
| 利息成本         | aicost        |                                                             |
| 债券票面利息     | bondintr      |                                                             |
| 利息计提         | lxjt          |                                                             |
| 市值金额         | mktvalue      | 等于 市场价格 * 持仓数量                                    |
| 持仓数量变动     | stkqty_ch     |                                                             |
| 持仓成本变动     | stkcost_ch    |                                                             |
| 浮动盈亏变动     | gyvalue_ch    |                                                             |
| 交易收益变动     | syvalue_ch    |                                                             |
| 利息收入变动     | lxsr_ch       |                                                             |
| 借出利息收入变动 | cjsr_ch       |                                                             |
| 借入利息费用变动 | jrzc_ch       |                                                             |
| 回购利息变动     | hglx_ch       |                                                             |
| 总计费用变动     | fee_ch        |                                                             |
| 净手续费变动     | jsxf_ch       |                                                             |
| 印花税变动       | yhs_ch        |                                                             |
| 过户费变动       | ghf_ch        |                                                             |
| 利息税变动       | lxs_ch        |                                                             |
| 其它费变动       | qtfee_ch      |                                                             |
| 利息成本变动     | aicost_ch     |                                                             |
| 利息计提变动     | lxjt_ch       |                                                             |
| 毛手续费变动     | sxf_ch        |                                                             |
| 外部转托金额变动 | stkadjust_ch  |                                                             |



说明
1)  流通类型（ltlx）相当于证券代码的补充。包括：00流通股 02配股 01限售流通 03申购状态 04收购状态 05融资融券 06融资回购 07融券回购 09股票质押 80多仓 81空仓。
    - 正常情况下一般都是00流通股，涉及到新股申购、未上市股份、融资融券、期货期权时才不为00。
2)  计提的目的是更新市场价值（MTM）和利息积数（accrual），是每天的一次操作。
    - 在核算完成后由外部单独步骤“公允与利息处理”触发。
3)  不参与交易量统计,非交易量金额，如ETF申赎现金替代、转债转股资金、行权资金等。
4)  是指在公司内部不同资产形式的转换，区别从外部转入转出的资产。
    - 含转托管入或出、ETF申赎转入或出、转债转股入或出、合并拆分入或出、ETF认购入或出、其他转换类入或出等。
    - 转入转出价格一般指定为当日收盘价格。不影响资金发生。 
5)  质押的证券不影响成本。相当于把证券“冻结”，因此会限制可出售的证券数量。
6)  借出证券不影响成本。但会减少允许出售的份数。
7)  外部转托管金额记录非我公司资产之间的转入转出。此项引起的资产增加或减少，视同基金的申购或退出。
    - 参考价格为当日收盘价。
9)  调整数量和调整金额可正可负。用于分红到帐和除权除息不同步时校正市值。
10) 利息收入核算已经交收的股息或者债券利息。
    - 判断是股息还是债券利息，可由证券代码进行区分。
    

## 客户资金明细表 `fundasset_hs`

资金头寸归集标准为：
  - 节点号、营业部号、客户号、银行代码、资金账号、货币类型。


| 变量名称         | 字段          | 说明                                          |
|------------------|---------------|-----------------------------------------------|
| 节点号           | serverid      | 对应业务流水相同字段                          |
| 营业部号         | orgid         | 对应业务流水相同字段                          |
| 客户号           | custid        | 对应业务流水相同字段                          |
| 资金帐号         | fundid        | 对应业务流水相同字段                          |
| 货币类型         | moneytype     | 对应业务流水相同字段                          |
| 银行代码         | bankcode      | 开户行标识                                    |
| 统计日期         | tjdate        |                                               |
| 备注             | remark        | 不限制内容                                    |
| 账户资金         | fundbal       | 受借出、借入的金额会影响                      |
| 存款金额         | fundsave      |                                               |
| 取款金额         | fundunsave    |                                               |
| 借出金额         | fundloan      |                                               |
| 借入金额         | funddebt      |                                               |
| 在途未收         | funduncome    | 应收账款                                      |
| 在途未付         | fundunpay     | 应付账款                                      |
| 利息积数         | fundintr      | 未发放的利息收入 说明 1)                      |
| 累计结息         | fundaward     | 已经发放的利息收入 说明 1)                    |
| 融资利息         | rzlx          |                                               |
| 账户资金变动     | fundbal_ch    |                                               |
| 取款金额变动     | fundunsave_ch |                                               |
| 存款金额变动     | fundsave_ch   |                                               |
| 借出金额变动     | fundloan_ch   |                                               |
| 借入金额变动     | funddebt_ch   |                                               |
| 在途未收变动     | funduncome_ch |                                               |
| 在途未付变动     | fundunpay_ch  |                                               |
| 利息积数变动     | fundintr_ch   |                                               |
| 累计结息变动     | fundaward_ch  |                                               |
| 融资利息变动     | rzlx_ch       |                                               |
| 外部资产增减变动 | fundadjust_ch | 等于：差分 外部资产增减                       |
| 外部资产增减     | fundadjust    | 说明 2)                                       |
| 上日余额         | fundlastbal   |                                               |



说明
1. 客户资金按活期存款计息，每季度发放。
    - 发放的总额就是累计结息。
    - 利息积数记录在发放利息之前已经累积的利息金额。类似于利息计提。
2. 包括资金转入转出或者外部转托管，影响折算份额的计算。


#### 各种标识id的意义
- custid：标识一个客户。
- orgid：标识一个营业部。一个客户归属于一个唯一的营业部（开户营业部）。
- serverid：标识一个按地理或业务区分的节点号。一个客户可以对应多个serverid。比如节点3和融资融券节点8。
- fundid：资金账号。同一个客户可以有多个资金账号，比如主账号、辅账号等。
- secuid：证券账号。同一个客户也可用拥有多个证券账号，比如在沪市、深市都开立了证券账号。

```
graph TB
orgid --> custid
custid --> serverid_1
custid --> serverid_2
custid --> fundid_1
custid --> fundid_2
custid --> secuid_1
custid --> secuid_2

style orgid fill:lightpink
style fundid_1 fill:lightblue
style fundid_2 fill:lightblue
style secuid_1 fill:lightgreen
style secuid_2 fill:lightgreen
style serverid_1 fill:lightyellow
style serverid_2 fill:lightyellow
```
