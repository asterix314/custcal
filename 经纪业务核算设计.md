# 经纪业务核算设计

[TOC]


## 核算设计

### 核算批量过程

- 数据库CustCal：原始交易流水、证券价格等。
- 数据库CustHis：按月存储核算结果

1. **系统初始化**  T-1日核算完成（数据归档）后，需执行系统初始化步骤后才能开始进行T日核算。
   - 初始化当前日期到T日。
   - 当日各变动字段（`*_ch`）置零。
   - 删除持仓表`stkasset_hs`中持仓等于0的行。
   - 存储过程：`system\sp_sysinit.sql`。可由C#服务端自动调用。
2. **数据准备** 准备各业务系统流水和行情数据。
   - 业务系统包括集中交易节点1、2、3、融资融券系统、个股期权、代客黄金、OTC、统一账户等。
   - 存储过程：`system\sp_Data_Prepare.sql`。可由C#服务端自动调用。
3. **交易流水核算**  逐笔核算交易流水。
   - 由C#服务端自动调用存储过程实现，多线程处理，每一个客户处于同一个线程，以保证顺序。
4. **计提处理**
   - 利息计提。
   - 公允价值（MTM）计提：计算市值和浮动盈亏。
   - 存储过程：`system\sp_Settle_Gyjt.sql`。可由C#服务端自动调用，多线程处理。
5. **一致性检查**  分多个维度对核算结果（资产、盈亏、费用）进行一致性检查，对不平项进行揭示，运维人员判定，如果出现问题，可执行系统回退。
   - 存储过程：`system\sp_SettleCheck.sql`。可由C#服务端自动调用，单线程处理。
6. **数据汇总**  汇总每一个客户的整体情况，包括总资产、总盈亏、总负债等。汇总公司级别的数据等。
   - 存储过程：`system\sp_DataSum.sql`。可由C#服务端自动调用，单线程处理。
7. **数据归档**  对当前核算结果以日期字段相应放到历史对应表中。
   - 存储过程：`system\sp_DataBack.sql`。可由C#服务端自动调用，单线程处理。


### 核算结果平衡校验

平衡校验表结构（`stkcheck`）

| 字段         | 类型    | 说明                                       |
|--------------|---------|--------------------------------------------|
| `backdate`   | int     |                                            |
| `check_type` | varchar | 校验类型：`FUND_LOG`，`FUND_ATTRIBUTION`等 |
| `serverid`   | varchar |                                            |
| `orgid`      | varchar |                                            |
| `custid`     | bigint  |                                            |
| `fundid`     | bigint  |                                            |
| `currency`   | varchar |                                            |
| `ltlx`       | varchar |                                            |
| `market`     | varchar |                                            |
| `stkcode`    | varchar |                                            |
| `lhs_name`   | varchar | 左侧名称                                   |
| `lhs_val`    | numeric | 左侧值                                     |
| `rhs_name`   | varchar | 右侧名称                                   |
| `rhs_val`    | numeric | 右侧值                                     |
| `diff`       | numeric | 左右值之差（应为零）                       |
| `name_0`     | varchar | 辅助变量名称                               |
| `val_0`      | numeric | 辅助变量值                                 |
| `name_1`     | varchar |                                            |
| `val_1`      | numeric |                                            |
| `name_2`     | varchar |                                            |
| `val_2`      | numeric |                                            |
| `name_3`     | varchar |                                            |
| `val_3`      | numeric |                                            |

从以下几个维度对核算结果（数量、资产、盈亏）进行校验。

1. 证券资产变动归因：`check_type='SECURITIES_ATTRIBUTION'`
   - 校验级别：分客户分证券
   - 部分资产金额：`stkcost_ch - syvalue_ch - lxsr_ch`
     - `stkbuyamt - stksaleamt`
     - `stkbuyamt_ex - stksaleamt_ex`
     - `stkztgramt - stkztgcamt`
     - `-stkhlamt`
   - 资产数量：`stkqty_ch`
     - `stkbuyqty - stksaleqty`
     - `stkbuyqty_ex - stksaleqty_ex`
     - `stkztgrqty - stkztgcqty`
     - `stkhgqty + stkpgqty`

```sql
with t as
  (select bfzc=stkcost_ch - syvalue_ch - lxsr_ch,
          bfzc_mm=stkbuyamt+stkbuyamt_ex-stksaleamt-stksaleamt_ex,
          bfzc_ztg=stkztgramt-stkztgcamt,
          bfzc_hl=-stkhlamt,
          sl_mm=stkbuyqty+stkbuyqty_ex-stksaleqty-stksaleqty_ex,
          sl_ztg=stkztgrqty-stkztgcqty,
          sl_hpg=stkhgqty+stkpgqty, *
     from stkasset_hs)

   select backdate=@sysdate, check_type='SECURITIES_ATTRIBUTION', serverid, orgid, custid, fundid,
          moneytype=case market when '2' then '1' when '3' then '2' else '0' end,
          ltlx, market, stkcode, 
          lhs_name='部分资产变动', lhs_val=bfzc,
          rhs_name='部分资产变动归因', rhs_val=bfzc_mm+bfzc_ztg+bfzc_hl,
          diff=bfzc-(bfzc_mm+bfzc_ztg+bfzc_hl),
          name_0='证券数量变动', val_0=stkqty_ch,
          name_1='证券数量变动归因', val_1=sl_mm+sl_ztg+sl_hpg,
          name_2='买卖金额', val_2=bfzc_mm,
          name_3='转入转出金额', val_3=bfzc_ztg,
          name_4='红利金额', val_4=bfzc_hl
     from t
    where bfzc!=(bfzc_mm+bfzc_ztg+bfzc_hl) or stkqty_ch!=sl_mm+sl_ztg+sl_hpg
```

2. 资金余额变动归因：`check_type='FUND_ATTRIBUTION'`
   - 校验级别：分客户分币种
   - 资金余额：`fundbal_ch`
     - `fundsave_ch - fundunsave_ch`
     - `fundaward_ch`
     - `-lxs_ch`
     - `fundadjust_ch`
     - `fundzqjy_ch + fundzqjy0_ch`
     - `fundbxyw_ch`
     - `fundotc_ch`
     - `fundkfjj_ch`
     - `fundgold_ch`
     - `fundother_ch`

```sql
with t as
  (select zjcq=fundsave_ch-fundunsave_ch,
          zqjy=fundzqjy_ch+fundzqjy0_ch,
          lxks=fundaward_ch-lxs_ch,
          fzqjy=fundbxyw_ch+fundotc_ch+fundkfjj_ch+fundgold_ch+fundother_ch+qtsz_ch,
          zjtz=fundadjust, *
     from fundasset_hs)

   select backdate=@sysdate, check_type='FUND_ATTRIBUTION', serverid, orgid, custid, fundid,
          moneytype, ltlx='*', market='*', stkcode='*', 
          lhs_name='资金余额变动', lhs_val=fundbal_ch,
          rhs_name='资金余额变动归因', rhs_val=zjcq+zqjy+lxks+fzqjy+zjtz,
          diff=fundbal_ch-(zjcq+zqjy+lxks+fzqjy+zjtz),
          name_0='资金存取', val_0=zjcq,
          name_1='证券交易', val_1=zqjy,
          name_2='利息及扣税', val_2=lxks,
          name_3='非证券交易', val_3=fzqjy,
          name_4='资金调整', val_4=zjtz
     from t
    where fundbal_ch!=(zjcq+zqjy+lxks+fzqjy+zjtz)

```

3. 资产负债表科目发生额试算平衡：`check_type='BS_CHANGES'`
     - 平衡公式：资产 + 费用 = 负债 + 损益 + 划拨
     - 校验级别：分客户分币种
     - 资产
       - 证券资产：`stkcost_ch + stkqty_tzje_ch`
       - 资金资产：`funduncome_ch + fundbal_ch + fundloan_ch`
     - 费用
       - 证券费用：`jrzc_ch + sxf_ch + ghf_ch + yhs_ch + qtfee_ch + lxs_ch`
       - 资金费用：`rzlx_ch`
     - 负债
       - 证券负债：用负成本`stkcost < 0`表示
       - 资金负债：`fundunpay_ch + funddebt_ch`
     - 损益
       - 证券损益：`cjsr_ch + lxsr_ch + syvalue_ch`
       - 资金损益：`fundaward_ch + rcsr_ch + qtsz_ch`
     - 划拨
       - 证券划拨：`stkadjust_ch`
       - 资金划拨：`fundadjust_ch + fundotc_ch + fundbxyw_ch + fundother_ch + fundgold_ch + fundsave_ch - fundunsave_ch`

```sql
with s as
  (select custid, orgid,
          moneytype=case market when '2' then '1' when '3' then '2' else '0' end,
          expense=sum(jrzc_ch+sxf_ch+ghf_ch+yhs_ch+qtfee_ch+lxs_ch),
          asset=sum(stkcost_ch+stkqty_tzje_ch), liab=0,
          pl=sum(cjsr_ch+lxsr_ch+syvalue_ch), trans=sum(stkadjust_ch)
     from stkasset_hs
 group by custid, orgid,
          case market when '2' then '1' when '3' then '2' else '0' end),
     f as
  (select custid, orgid, moneytype,
          expense=sum(rzlx_ch), asset=sum(funduncome_ch+fundbal_ch+fundloan_ch),
          liab=sum(fundunpay_ch+funddebt_ch), pl=sum(fundaward_ch+rcsr_ch+qtsz_ch),
          trans=sum(fundadjust_ch+fundotc_ch+fundbxyw_ch+fundother_ch+fundgold_ch+fundsave_ch-fundunsave_ch) 
     from fundasset_hs
 group by custid, orgid, moneytype)

   select backdate=@sysdate, check_type='BS_CHANGES', serverid='*', orgid=s.orgid, custid=s.custid,
          fundid=0, moneytype=f.moneytype, ltlx='*', market='*', stkcode='*',
          lhs_name='资产 + 费用', lhs_val = (s.expense+f.expense+s.asset+f.asset),
          rhs_name='负债 + 损益 + 划拨', rhs_val=(s.liab+f.liab+s.pl+f.pl+s.trans+f.trans),
          diff=(s.expense+f.expense+s.asset+f.asset)-(s.liab+f.liab+s.pl+f.pl+s.trans+f.trans),
          name_0='资产', val_0=s.asset+f.asset,
          name_1='费用', val_1=s.expense+f.expense,
          name_2='负债', val_2=s.liab+f.liab,
          name_3='损益', val_3=s.pl+f.pl,
          name_4='划拨', val_4=s.trans+f.trans
     from s full join f on
          s.orgid=f.orgid and s.custid=f.custid and s.moneytype=f.moneytype
    where (s.expense+f.expense+s.asset+f.asset)-(s.liab+f.liab+s.pl+f.pl+s.trans+f.trans)!=0
```

4. 资产负债表科目余额试算平衡：`check_type='BS_BALANCES'`
     - 原理同科目发生额借贷平衡，但是校验初始化以来的汇总值。
     - 校验级别：分客户分币种
     - 资产
       - 证券资产：`stkcost + stkqty_tzje`
       - 资金资产：`funduncome + fundbal + fundloan`
     - 费用
       - 证券费用：`jrzc + sxf + ghf + yhs + qtfee + lxs`
       - 资金费用：`rzlx`
     - 负债
       - 证券负债：用负成本`stkcost < 0`表示
       - 资金负债：`fundunpay + funddebt`
     - 损益
       - 证券损益：`cjsr + lxsr + syvalue`
       - 资金损益：`fundaward + rcsr + qtsz`
     - 划拨
       - 证券划拨：`stkadjust`
       - 资金划拨：`fundadjust + fundotc + fundbxyw + fundother + fundgold + fundsave - fundunsave`

```sql
with s as
  (select custid, orgid,
          moneytype=case market when '2' then '1' when '3' then '2' else '0' end,
          expense=sum(jrzc+sxf+ghf+yhs+qtfee+lxs),
          asset=sum(stkcost+stkqty_tzje), liab=0,
          pl=sum(cjsr+lxsr+syvalue), trans=sum(stkadjust)
     from stkasset_hs
 group by custid, orgid,
          case market when '2' then '1' when '3' then '2' else '0' end),
     f as
  (select custid, orgid, moneytype,
          expense=sum(rzlx), asset=sum(funduncome+fundbal+fundloan),
          liab=sum(fundunpay+funddebt), pl=sum(fundaward+rcsr+qtsz),
          trans=sum(fundadjust+fundotc+fundbxyw+fundother+fundgold+fundsave-fundunsave) 
     from fundasset_hs
 group by custid, orgid, moneytype)

   select backdate=@sysdate, check_type='BS_BALANCES', serverid='*', orgid=s.orgid, custid=s.custid,
          fundid=0, moneytype=f.moneytype, ltlx='*', market='*', stkcode='*',
          lhs_name='资产 + 费用', lhs_val = (s.expense+f.expense+s.asset+f.asset),
          rhs_name='负债 + 损益 + 划拨', rhs_val=(s.liab+f.liab+s.pl+f.pl+s.trans+f.trans),
          diff=(s.expense+f.expense+s.asset+f.asset)-(s.liab+f.liab+s.pl+f.pl+s.trans+f.trans),
          name_0='资产', val_0=s.asset+f.asset,
          name_1='费用', val_1=s.expense+f.expense,
          name_2='负债', val_2=s.liab+f.liab,
          name_3='损益', val_3=s.pl+f.pl,
          name_4='划拨', val_4=s.trans+f.trans
     from s full join f on
          s.orgid=f.orgid and s.custid=f.custid and s.moneytype=f.moneytype
    where (s.expense+f.expense+s.asset+f.asset)-(s.liab+f.liab+s.pl+f.pl+s.trans+f.trans)!=0

```

系统初始化时，各科目余额可能不平。可用以下SQL通过`stkadjust`和`fundadjust`调平：

```sql
update CustHis0..stkasset_hs_2016 set stkadjust=
  stkcost + stkqty_tzje
+ (jrzc + sxf + ghf + yhs + qtfee + lxs)
- (cjsr + lxsr + syvalue)

update CustHis0..fundasset_hs_2016 set fundadjust=
  funduncome + fundbal + fundloan + rzlx
- (fundunpay + funddebt)
- (fundaward + rcsr + qtsz)
- (fundotc + fundbxyw + fundother + fundgold + fundsave - fundunsave)
```

5. 交易流水费用项校验：`check_type='FEE_LOG'`
  - 流水中的费用项应对应证券资产表中的相关栏位。
  - 校验级别：分客户分证券

| `logasset_hs`        | `stkasset_hs` |
|----------------------|---------------|
| `fee_sxf`            | `sxf_ch`      |
| `fee_jsxf`           | `jsxf_ch`     |
| `fee_ghf`            | `ghf_ch`      |
| `fee_yhs`            | `yhs_ch`      |
| `fee_qtf + feefront` | `qtfee_ch`    |


```sql
with g as
  (select custid, serverid, market, stkcode,
          sxf=sum(fee_sxf), jsxf=sum(fee_jsxf), ghf=sum(fee_ghf),
          yhs=sum(fee_yhs), qtfee=sum(feefront),
          fee_sum=sum(fee_sxf+fee_jsxf+fee_ghf+fee_yhs+feefront)
     from logasset_hs
    where bizdate=@sysdate and stkcode!=''
 group by custid, serverid, market, stkcode),

     s as
  (select custid, serverid, market, stkcode, orgid, ltlx,
          sxf_ch, jsxf_ch, ghf_ch, yhs_ch, qtfee_ch,
          fee_sum=sxf_ch+jsxf_ch+ghf_ch+yhs_ch+qtfee_ch,
          moneytype=case market when '2' then '1' when '3' then '2' else '0' end
     from stkasset_hs
    where stkcode!='')

   select backdate=@sysdate, check_type='FEE_LOG', serverid=s.serverid, orgid=s.orgid,
          custid=s.custid, fundid=0, currency=s.moneytype, ltlx=s.ltlx, market=s.market,
          stkcode=s.stkcode,
          lhs_name='流水费用发生', lhs_val=g.fee_sum,
          rhs_name='证券费用变动', rhs_val=s.fee_sum,
          diff=g.fee_sum-s.fee_sum,
          name_0='log.sxf', val_0=g.sxf,
          name_1='stk.sxf', val_1=s.sxf_ch,
          name_2='log.jsxf', val_2=g.jsxf,
          name_3='stk.jsxf', val_3=s.jsxf_ch,
          name_4='log.ghf', val_4=g.ghf,
          name_5='stk.ghf', val_5=s.ghf_ch,
          name_6='log.yhs', val_6=g.yhs,
          name_7='stk.yhs', val_7=s.yhs_ch
     from g full join s on
          g.custid=s.custid and g.serverid=s.serverid and
          g.market=s.market and g.stkcode=s.stkcode
    where g.fee_sum!=s.fee_sum
```

6. 交易流水资金变动校验：交易流水中的资金发生项（`logasset_hs.fundeffect`），应落实为资金资产的余额变动项（`fundasset_hs.fundbal_ch`）。

```sql
with g as
  (select custid, serverid, orgid, moneytype,
          fundeffect=sum(fundeffect)
     from logasset_hs
    where bizdate=@sysdate
 group by custid, serverid, orgid, moneytype),

     f as
  (select custid, serverid, orgid, moneytype,
          fundbal_ch=sum(fundbal_ch)
     from fundasset_hs
 group by custid, serverid, orgid, moneytype)

   select backdate=@sysdate, check_type='FUND_LOG', serverid=g.serverid, orgid=g.orgid, custid=g.custid,
          fundid=0, moneytype=g.moneytype, ltlx='*', market='*', stkcode='*',
          lhs_name='流水资金发生', lhs_val=g.fundeffect,
          rhs_name='资金余额变动', rhs_val=f.fundbal_ch,
          diff=g.fundeffect-f.fundbal_ch
     from g full join f on
          g.orgid=f.orgid and g.custid=f.custid and g.moneytype=f.moneytype
    where g.fundeffect!=f.fundbal_ch
```


7. 交易流水股份变动校验：交易流水中的股份发生项（`logasset_hs.stkeffect`），应落实为证券资产的股份变动项（`stkasset_hs.stkqty_ch`）。


### 公允价值计提

- `mktvalue`：市值、公允价值
- `gyvalue`：公允价值与成本之差
- `gyvalue_ch`：是`gyvalue`与上一次估值日的变化值。

按以下顺序进行公允价值的批量计提。

1. 若该头寸无持仓（`stkqty=0`）但成本不为零，则公允价值（`mktvalue`）设为0，同时将成本转入收益（`syvalue`）。
   - 这种情况是不应该发生的（无持仓则成本应为零），若发生则需查看原因。

```sql
   update stkasset_hs
      set syvalue=syvalue-stkcost, syvalue_ch=syvalue_ch-stkcost, 
          mktvalue=0, stkcost=0, stkcost_ch=stkcost_ch-stkcost,
          gyvalue=0, gyvalue_ch=gyvalue_ch-gyvalue,
          gydate=@sysdate, remark='批量公允计提(无数量冲成本为0)'              
    where stkqty=0 and stkcost!=0 
```

2. 头寸种类（`ltlx`）属于正常估值范围，且有市场价格可用（`stkprice.lastprice>0`）。

```sql
   update s
      set stkprice=p.lastprice, mktvalue=stkqty*p.lastprice,
          gyvalue=stkqty*p.lastprice-stkcost,
          gyvalue_ch=stkqty*p.lastprice-stkcost-gyvalue,
          gydate=@sysdate, remark='批量公允计提(市场价格>0)'              
     from stkasset_hs s inner join stkprice_hs p on s.stkcode=p.stkcode and s.market=p.market 
    where s.ltlx in (需计算公允价值的类型) and p.bizdate=@sysdate and p.lastprice>0
```

3. 其它情况（无需估值或无市价等情况），以成本作为公允价值。

```sql
   update stkasset_hs
      set stkprice=0, mktvalue=stkcost, gyvalue=0, gyvalue_ch=gyvalue_ch-gyvalue,
          gydate=@sysdate, remark='批量公允计提(市值同成本)'              
     from stkasset_hs
    where gydate!=@sysdate

```

## 数据提取

### 资金股份流水

- 按月导出节点表，如： `select * from JD1HIS.his.dbo.logasset_2017_03`。
- 包括：A股节点123、B股、融资融券。
- 导入相应流水表，如`logasset_jd1_2017_03`。
- 导入前注意把表清空（`truncate`）。

### 证券市场价格

- 开放基金的净值数据。
- 证券收盘价，包括：A股节点123，B股，融资融券。
- 导出逻辑加入了去重处理。
- 导入目标表：`stkprice_2017`。

```sql
create view v_stkprice_2017 as
with
fundprice as (
  select bizdate=sysdate, market='J', stkcode=ofcode, closeprice=nav,
    openprice=nav, lastprice=nav, highprice=nav, lowprice=nav, bondintr=0.0
  from JD1.run.dbo.ofcodevalue
  where sysdate>20161225
  union all
  select  bizdate=sysdate, market='J', stkcode=ofcode, closeprice=nav,
    openprice=nav, lastprice=nav, highprice=nav, lowprice=nav, bondintr=0.0
  from JD2.run.dbo.ofcodevalue
  where sysdate>20161225
  union all
  select  bizdate=sysdate, market='J', stkcode=ofcode, closeprice=nav,
    openprice=nav, lastprice=nav, highprice=nav, lowprice=nav, bondintr=0.0
  from JD3.run.dbo.ofcodevalue
  where sysdate>20161225),

stkprice as (
  select bizdate, market, stkcode, closeprice=closeprice, openprice=openprice,
    lastprice=lastprice, highprice=highprice, lowprice=lowprice, bondintr=bondintr
  from JD1HIS.his.dbo.h_stkprice_2017
  union all
  select bizdate, market, stkcode, closeprice=closeprice, openprice=openprice,
    lastprice=lastprice, highprice=highprice, lowprice=lowprice, bondintr=bondintr
  from JD2HIS.his.dbo.h_stkprice_2017
  union all
  select bizdate, market, stkcode, closeprice=closeprice, openprice=openprice,
    lastprice=lastprice, highprice=highprice, lowprice=lowprice, bondintr=bondintr
  from JD3HIS.his.dbo.h_stkprice_2017
  union all
  select bizdate, market, stkcode, closeprice=closeprice, openprice=openprice,
    lastprice=lastprice, highprice=highprice, lowprice=lowprice, bondintr=bondintr
  from BGHIS.his.dbo.h_stkprice_2017
  union all
  select bizdate, market, stkcode, closeprice=closeprice, openprice=openprice,
    lastprice=lastprice, highprice=highprice, lowprice=lowprice, bondintr=bondintr
  from RZRQHIS.his.dbo.h_stkprice_2017)

select bizdate, market, stkcode, closeprice=max(closeprice), openprice=max(openprice),
    lastprice=max(lastprice), highprice=max(highprice), lowprice=max(lowprice), bondintr=max(bondintr)
from (select * from fundprice union all select * from stkprice) as foo
group by bizdate, market, stkcode

```

### 证券信息

- 主要是权证和正股的连接信息。
- 包括：A股节点123、B股、融资融券。
- 导入目标表：`stktrd_2017`
  


```sql
create view v_stktrd_2017 as (
  select market, stkcode, linkstk, frzstk, stkname, stktype
  from  JD1.run.dbo.stktrd
  union
  select market, stkcode, linkstk, frzstk, stkname, stktype
  from  JD2.run.dbo.stktrd
  union 
  select market, stkcode, linkstk, frzstk, stkname, stktype
  from  JD3.run.dbo.stktrd
  union 
  select market, stkcode, linkstk, frzstk, stkname, stktype
  from  BG.run.dbo.stktrd
  union
  select market, stkcode, linkstk, frzstk, stkname, stktype
  from  RZRQ.run.dbo.stktrd)
```

### 去年末证券持仓

- 包含：A股节点123、B股、融资融券、平安银行理财代销
- 导入目标：`stkasset_20161230`

```sql
create view v_stkasset_20161230 as (
  select backdate=20161230, serverid, orgid, custid, fundid, market, stkcode, 
    stkqty=sum(stkbal), stkcost=sum(lastbuycost)
  from ZHISJD1.run120161230.dbo.stkasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, market, stkcode
union all
  select backdate=20161230, serverid, orgid, custid, fundid, market, stkcode, 
    stkqty=sum(stkbal), stkcost=sum(lastbuycost)
  from ZHISJD2.run220161230.dbo.stkasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, market, stkcode
union all
  select backdate=20161230, serverid, orgid, custid, fundid, market, stkcode, 
    stkqty=sum(stkbal), stkcost=sum(lastbuycost)
  from ZHISJD3.run320161230.dbo.stkasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, market, stkcode
union all
  select backdate=20161230, serverid, orgid, custid, fundid, market, stkcode, 
    stkqty=sum(stkbal), stkcost=sum(lastbuycost)
  from ZHISJD7.run720161230.dbo.stkasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, market, stkcode
union all
  select backdate=20161230, serverid, orgid, custid, fundid, market, stkcode, 
    stkqty=sum(stkbal), stkcost=sum(lastbuycost)
  from ZHISJD8.rzrq20161230.dbo.stkasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, market, stkcode
union all
  select backdate=20161230, serverid, orgid, custid, fundid, market='L', stkcode=bkcode, 
    stkqty=sum(bkbal), stkcost=sum(bkbal)
  from ZHISJD3.run320161230.dbo.otcbasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, bkcode)
```

### 去年末资金余额

- 包括：A股节点123、B股、融资融券。
- 导入目标：`fundasset_20161230`

```sql
create view v_fundasset_20161230 as (
  select backdate=20170100, serverid, orgid, custid, fundid, moneytype, 
    fundbal=sum(fundbal)
  from  ZHISJD1.run120161230.dbo.fundasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, moneytype
union all
  select backdate=20170100, serverid, orgid, custid, fundid, moneytype, 
    fundbal=sum(fundbal)
  from  ZHISJD2.run220161230.dbo.fundasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, moneytype
union all
  select backdate=20170100, serverid, orgid, custid, fundid, moneytype, 
    fundbal=sum(fundbal)
  from  ZHISJD3.run320161230.dbo.fundasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, moneytype
union all
  select backdate=20170100, serverid, orgid, custid, fundid, moneytype, 
    fundbal=sum(fundbal)
  from  ZHISJD7.run720161230.dbo.fundasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, moneytype
union all
  select backdate=20170100, serverid, orgid, custid, fundid, moneytype, 
    fundbal=sum(fundbal)
  from ZHISJD8.rzrq20161230.dbo.fundasset
  where orgid not in ('0000','1235','1237','9999')
  group by serverid, orgid, custid, fundid, moneytype)
```

### 股票质押

- 包括：A股节点123、融资融券。
- 导入目标表：`gpzy_debt_20161230`和`gpzy_debt_detail_20161230`。

```
create view v_gpzy_debt_20161230 as (
  select * from ZHISJD1.run120161230.dbo.gpzy_debt
union all
  select * from ZHISJD2.run220161230.dbo.gpzy_debt
union all
  select * from ZHISJD3.run320161230.dbo.gpzy_debt 
union all
  select * from ZHISJD7.run720161230.dbo.gpzy_debt)

create view v_gpzy_debt_detail_20161230 as (
  select * from ZHISJD1.run120161230.dbo.gpzy_debt_detail
union all
  select * from ZHISJD2.run220161230.dbo.gpzy_debt_detail
union all
  select * from ZHISJD3.run320161230.dbo.gpzy_debt_detail
union all
  select * from ZHISJD7.run720161230.dbo.gpzy_debt_detail)
```

### 债券质押回购

- 包括：A股节点123
- 导入目标表：`zyhg_stkasset_20161230`

```sql
create view v_zyhg_stkasset_20161230 as (
  select serverid, orgid, custid, fundid, market, stkcode, ltlx='07', stkdebt=SUM(bondbal) 
  from ZHISJD1.run120161230.dbo.bb_bondasset
  group by serverid, orgid, custid, fundid, market, stkcode
  having sum(bondbal)>0
union all  
  select serverid, orgid, custid, fundid, market, stkcode, ltlx='07', stkdebt=SUM(bondbal) 
  from ZHISJD2.run220161230.dbo.bb_bondasset
  group by serverid, orgid, custid, fundid, market, stkcode
  having sum(bondbal)>0
union all  
  select serverid, orgid, custid, fundid, market, stkcode, ltlx='07', stkdebt=SUM(bondbal) 
  from ZHISJD3.run320161230.dbo.bb_bondasset
  group by serverid, orgid, custid, fundid, market, stkcode
  having sum(bondbal)>0
union all  
  select serverid, orgid, custid, fundid, market, stkcode, ltlx='07', stkdebt=SUM(bondbal) 
  from ZHISJD7.run720161230.dbo.bb_bondasset
  group by serverid, orgid, custid, fundid, market, stkcode
  having sum(bondbal)>0
union all  
  select serverid, orgid, custid, fundid, market, stkcode, ltlx='07', stkdebt=SUM(bondbal) 
  from ZHISJD8.rzrq20161230.dbo.bb_bondasset
  group by serverid, orgid, custid, fundid, market, stkcode
  having sum(bondbal)>0)
```

### 报价回购

- 包括：A股节点123
- 导入目标表：`bj_contract_20161230`
- 目前只有深圳市场有报价回购。

```sql
create view v_bj_contract_20161230 as (
  select * from ZHISJD1.run120161230.dbo.bj_contract_sz
  where contracttype=0 and enddate>20170100
union all
  select * from ZHISJD2.run220161230.dbo.bj_contract_sz
  where contracttype=0 and enddate>20170100
union all
  select * from ZHISJD3.run320161230.dbo.bj_contract_sz
  where contracttype=0 and enddate>20170100)
```

### 股票质押约定回购

```sql
create view v_ydgh_debt_20161230 as (
  select * from ZHISJD1.run120161230.dbo.ydgh_debt
  where enddate>20170100
union all
  select * from ZHISJD2.run220161230.dbo.ydgh_debt
  where enddate>20170100
union all
  select * from ZHISJD3.run320161230.dbo.ydgh_debt
  where enddate>20170100)
```


## 核算初始化

### 流通股份持仓

- 目标：`CustHis..stkasset_hs_2016`

```sql
truncate table CustHis..stkasset_hs_2016

insert into CustHis..stkasset_hs_2016(
  backdate, serverid, orgid, custid, fundid, market, stkcode, stkqty, stkcost)
select 20170100, serverid, orgid, custid, fundid, market, stkcode, stkqty, stkcost
from stkasset_20161230
```

### 客户资金余额

- 目标：`CustHis..fundasset_hs_2016`

```sql
truncate table CustHis..fundasset_hs_2016

insert into CustHis..fundasset_hs_2016(
  backdate, serverid, orgid, custid, fundid, moneytype, fundbal)
select 20170100, serverid, orgid, custid, fundid, moneytype, fundbal
from fundasset_20161230
```

### 证券收盘价格

- 目标：`stkprice`
- 将上年度12月和本年度的导入价格合并入`stkprice`表

```sql
truncate table stkprice

insert into stkprice(
  bizdate, market, stkcode, closeprice, openprice, lastprice, highprice, lowprice, bondintr)
select bizdate, market, stkcode, closeprice=max(closeprice), openprice=max(openprice),
    lastprice=max(lastprice), highprice=max(highprice), lowprice=max(lowprice), bondintr=max(bondintr)
from (
  select bizdate, market, stkcode, closeprice, openprice, lastprice, highprice, lowprice, bondintr
  from stkprice_backup where bizdate > 20161200
  union all
  select bizdate, market, stkcode, closeprice, openprice, lastprice, highprice, lowprice, bondintr
  from stkprice_2017) as foo
group by bizdate, market, stkcode
```

### 证券信息

- 目标：`stktrd`。
- 须保证`(market, stkcode)`的唯一性。

```sql
truncate table stktrd

with 
u as (
  select market, stkcode, linkstk, frzstk, stkname, stktype
  from stktrd_backup
  union all
  select market, stkcode, linkstk, frzstk, stkname, stktype
  from stktrd_2017),
t as (
  select *, row_number() over (partition by market, stkcode
      order by len(linkstk) desc, len(stkname) desc) as rn
  from u)
insert into stktrd
select market, stkcode, linkstk, frzstk, stkname, stktype
from t where rn = 1
```

### 股票质押

1. 准备股票质押未还本金资金和质押股份数据

```sql

drop table CustHis..gpzy_fundasset_hs_init

  select serverid, orgid, custid, fundid, gpzysno, market, stkcode, orderid, loanerseat, loanersecuid,
         matchamt=sum(matchamt), re_matchamt=sum(backamt), re_intr=sum(payinterest),
         stkcost=sum(matchamt)-sum(backamt), ct=count(*)
    into CustHis..gpzy_fundasset_hs_init
    from gpzy_debt_20161230 where status!='1'
group by serverid, orgid, custid, fundid, gpzysno, market, stkcode, orderid, loanerseat, loanersecuid

drop table CustHis..gpzy_stkasset_hs_init

with a as (
  select gpzysno, market, stkcode, 
         ltlx=case when (market='0' and stkprop='00') or (market='1' and sdstktype='PT') then '00' else '09' end,
         matchqty=SUM(matchqty+bonusqty-backqty), ct=COUNT(*), itemno=MIN(itemno)
    from gpzy_debt_detail_20161230 where status!='1'
group by gpzysno, market, stkcode, 
         case when (market='0' and stkprop='00') or (market='1' and sdstktype='PT') then '00' else '09' end)

  select distinct serverid, orgid, custid, fundid, a.* 
    into CustHis..gpzy_stkasset_hs_init
    from a
inner join CustHis..gpzy_fundasset_hs_init b on a.gpzysno=b.gpzysno
```

2. 更新未还本金资金到`funddebt`字段

```sql
   insert into CustHis..fundasset_hs_2016(backdate, serverid, orgid, custid, fundid, moneytype, remark)
   select distinct backdate=20170100, b.serverid, b.orgid, b.custid, b.fundid, moneytype='0', '股票质押初始化插入'
     from CustHis..fundasset_hs_2016 a
full join CustHis..gpzy_fundasset_hs_init b on a.fundid=b.fundid and a.custid=b.custid and a.orgid=b.orgid and
          a.serverid=b.serverid
    where a.serverid is null

   update a
      set funddebt=funddebt+b.stkcost
    select * from CustHis..fundasset_hs_2016 a
full join (select serverid, orgid, custid, fundid, stkcost=sum(stkcost) 
             from CustHis..gpzy_fundasset_hs_init
         group by serverid, orgid, custid, fundid) 
           as b on a.fundid=b.fundid and a.custid=b.custid and a.orgid=b.orgid and a.serverid=b.serverid
    where a.moneytype='0' and b.serverid is not null
 ```

3. 更新抵押股份质押数据到`stkpledge`字段

```sql
   insert CustHis..stkasset_hs_2016(backdate, serverid, orgid, custid, fundid, market, stkcode, ltlx, remark)
   select distinct 20170100, b.serverid, b.orgid, b.custid, b.fundid, b.market, b.stkcode, b.ltlx, '股票质押'
     from CustHis..stkasset_hs_2016 a
full join CustHis..gpzy_stkasset_hs_init b on a.stkcode=b.stkcode and a.market=b.market and a.ltlx=b.ltlx and
          a.custid=b.custid and a.orgid=b.orgid and a.serverid=b.serverid
    where a.serverid is null

   update a
      set stkpledge=b.matchqty
     from CustHis..stkasset_hs_2016 a
full join (select serverid, orgid, custid, fundid, market, stkcode, ltlx, matchqty=sum(matchqty) 
             from CustHis..gpzy_stkasset_hs_init
         group by serverid, orgid, custid, fundid, market, stkcode, ltlx) b 
       on a.stkcode=b.stkcode and a.market=b.market and a.ltlx=b.ltlx and a.custid=b.custid and
          a.orgid=b.orgid and a.serverid=b.serverid
    where b.serverid is not null 

   update a
      set stkqty=stkqty+stkpledge 
     from CustHis..stkasset_hs_2016 a
    where serverid!='8' and stkpledge>0 and market='0' and ltlx='00' 

   update a
      set stkqty=stkpledge 
     from CustHis..stkasset_hs_2016 a
    where serverid!='8' and stkpledge>0 and ltlx='01' 

   update a
      set stkprice=lastprice, stkcost=lastprice*stkqty, mktvalue= lastprice*stkqty,
          yearqty=stkqty, yearcost=lastprice*stkqty, gydate=20170100, jtdate=20170100
     from CustHis..stkasset_hs_2016 a
inner join stkprice b on a.stkcode=b.stkcode and a.market=b.market 
    where b.bizdate=20161230 and a.ltlx in ('00','01','05')
```

4. 股票质押的ETF在途数据

```sql
delete ETF_Sgsh_ where busintype=221204

insert CustHis..ETF_Sgsh_2016(
  backdate,serverid, orgid, custid, busintype, businname, orderdate, ordersno, orderid, 
  bizdate, sno, market, stkcode, matchqty, matchamt, xjtd, stkcost, tx_matchqty,
  tx_xjtd, tx_stkcost, qtje, tx_ct, lastsno, ref_date, ref_sno, status, remark)
select 20170100, serverid, orgid, custid, busintype=221204, businname='股票质押初始交易(融资)-'+ltlx, 
  orderdate=left(gpzysno,8), ordersno=ltlx, orderid=RIGHT(gpzysno, len(gpzysno)-9),
  bizdate=left(gpzysno,8), sno=itemno, market, stkcode, matchqty=matchqty, matchamt=0, xjtd=0, stkcost=0, 
  tx_matchqty=0, tx_xjtd=0, tx_stkcost=0, qtje=0, tx_ct=1, lastsno=itemno, ref_date=0, ref_sno=0, 
  status='0', remark='股票质押初始交易(融资)，未购回'
from CustHis..gpzy_stkasset_hs_init              

   update a
      set matchamt=b.stkcost, stkcost=b.stkcost
     from CustHis..ETF_Sgsh_2016 a
full join CustHis..gpzy_fundasset_hs_init b 
       on a.stkcode=b.stkcode and a.market=b.market and a.orderid=RIGHT(b.gpzysno, len(b.gpzysno)-9) and 
          a.custid=b.custid and a.orgid=b.orgid and a.serverid=b.serverid and a.bizdate =LEFT(b.gpzysno,8)
    where b.serverid is not null and a.sno=1
```

5. 股票质押融券的ETF在途数据

```sql
delete from CustHis..ETF_Sgsh_2016 where busintype=221207
insert CustHis..ETF_Sgsh_2016
   select 20170100,serverid, orgid, custid, busintype='221207', businname='股票质押初始交易(融券)', orderdate, ordersno, 
          orderid=gpzysno,
          bizdate, sno, market, stkcode, matchqty, matchamt=matchamt, xjtd=0, stkcost=matchamt, tx_matchqty=0,
          tx_xjtd=0, tx_stkcost=0, qtje=0, tx_ct=1, lastsno=sno, ref_date=0, ref_sno=0, 
          status='0', remark='股票质押初始交易(融券)，未购回' 
 from CustCal..gpzy_logasset_full where digestid=221207
and gpzysno in (select CONVERT(varchar, bizdate)+market+orderid from CustHis..ETF_Sgsh_2016 where busintype='221204')                 

delete from CustHis..stkasset_hs_2016 where ltlx='37'
   insert into CustHis..stkasset_hs_2016 (
          backdate, serverid, orgid, custid, fundid, market, stkcode, ltlx,
          stkqty, mktvalue, stkcost, remark)
   select backdate=20170100, b.serverid, b.orgid, b.custid, fundid=0, b.market, b.stkcode, ltlx='37',
          stkqty=sum(matchamt), mtkvalue=sum(matchamt), stkcost=sum(matchamt), remark='股票质押'
     from CustHis..stkasset_hs_2016 a
full join CustHis..ETF_Sgsh_2016 b on a.stkcode=b.stkcode and a.market=b.market and a.custid=b.custid and a.orgid=b.orgid and a.serverid=b.serverid
    where a.serverid is null and isnull(a.ltlx,'37')='37'
    group by b.serverid, b.orgid, b.custid, b.market, b.stkcode
```

### 债券质押回购

```sql
  insert CustHis..stkasset_hs_2016(backdate, serverid, orgid, custid, fundid, market, stkcode, ltlx, remark)
  select distinct 20170100, b.serverid, b.orgid, b.custid, b.fundid, b.market, b.stkcode, b.ltlx, remark='债券质押回购'
    from CustHis..stkasset_hs_2016 a
full join zyhg_stkasset_20161230 b
  on a.stkcode=b.stkcode and a.market=b.market and a.ltlx=b.ltlx and a.custid=b.custid and
    a.orgid=b.orgid and a.serverid=b.serverid
  where a.serverid is null

  update a set stkpledge=stkpledge+b.stkdebt, stkqty=stkqty+b.stkdebt
  from CustHis..stkasset_hs_2016 a inner join zyhg_stkasset_20161230 b
   on a.stkcode=b.stkcode and a.market=b.market and a.ltlx=b.ltlx and a.custid=b.custid and
     a.orgid=b.orgid and a.serverid=b.serverid
```       

### 报价回购（建投融资）


```sql
insert into CustHis..stkasset_hs_2016(
  backdate, serverid, orgid, custid, fundid, market, stkcode, ltlx, stkqty, stkcost)
select backdate=20170100, serverid, orgid, custid, fundid, market, stkcode, ltlx='27',
  stkqty=sum(matchqty), stkcost=sum(matchamt)
from bj_contract_20161230
group by serverid, orgid, custid, fundid, market, stkcode
```

### 约定回购（客户融资）

```sql
insert into CustHis..stkasset_hs_2016(
  backdate, serverid, orgid, custid, fundid, market, stkcode, ltlx, stkqty, stkcost)
select backdate=20170100, serverid, orgid, custid, fundid, market, stkcode, ltlx='16',
  stkqty=-sum(matchqty), stkcost=-sum(matchamt)
from ydgh_debt_20161230
group by serverid, orgid, custid, fundid, market, stkcode
```

### 第一天数据加载

```sql
truncate table stkasset_hs

insert into stkasset_hs(
  serverid, orgid, custid, fundid, market, stkcode, ltlx,
  stkbuyqty, stkbuyamt, stksaleqty, stksaleamt, stkbuyqty_ex,
  stkbuyamt_ex, stksaleqty_ex, stksaleamt_ex, stkztgrqty, stkztgramt,
  stkztgcqty, stkztgcamt, stkhgqty, stkhlamt, stkpgqty, stkpgamt,
  stkqty, stkqty_ch, stkqty_tz, stkqty_tzje, stkqty_tzje_ch,
  stkpledge, stkpledge_ch, stkdebt, stkdebt_ch, stkloan, stkloan_ch,
  stkadjust, stkadjust_ch, stkprice, bondintr, mktvalue, aiamount,
  stkcost, stkcost_ch, aicost, aicost_ch, syvalue, syvalue_ch,
  lxsr, lxsr_ch, gyvalue, gyvalue_ch, lxjt, lxjt_ch, cjsr, cjsr_ch,
  jrzc, jrzc_ch, sxf, sxf_ch, yhs, yhs_ch, lxs, lxs_ch, jsxf, jsxf_ch,
  ghf, ghf_ch, qtfee, qtfee_ch, yearqty, yearcost, yeargyvalue, yearlxjt,
  jtdate, gydate, opendate, remark)
select   serverid, orgid, custid, fundid, market, stkcode, ltlx,
  stkbuyqty, stkbuyamt, stksaleqty, stksaleamt, stkbuyqty_ex,
  stkbuyamt_ex, stksaleqty_ex, stksaleamt_ex, stkztgrqty, stkztgramt,
  stkztgcqty, stkztgcamt, stkhgqty, stkhlamt, stkpgqty, stkpgamt,
  stkqty, stkqty_ch, stkqty_tz, stkqty_tzje, stkqty_tzje_ch,
  stkpledge, stkpledge_ch, stkdebt, stkdebt_ch, stkloan, stkloan_ch,
  stkadjust, stkadjust_ch, stkprice, bondintr, mktvalue, aiamount,
  stkcost, stkcost_ch, aicost, aicost_ch, syvalue, syvalue_ch,
  lxsr, lxsr_ch, gyvalue, gyvalue_ch, lxjt, lxjt_ch, cjsr, cjsr_ch,
  jrzc, jrzc_ch, sxf, sxf_ch, yhs, yhs_ch, lxs, lxs_ch, jsxf, jsxf_ch,
  ghf, ghf_ch, qtfee, qtfee_ch, yearqty, yearcost, yeargyvalue, yearlxjt,
  jtdate, gydate, opendate, remark
from CustHis..stkasset_hs_2016


truncate table fundasset_hs

insert into fundasset_hs(
  serverid, orgid, custid, fundid, moneytype, fundlastbal, fundbal, fundbal_ch,
  fundsave, fundsave_ch, fundunsave, fundunsave_ch, fundzqjy_ch, fundzqjy0_ch,
  fundbxyw, fundbxyw_ch, fundotc, fundotc_ch, fundkfjj, fundkfjj_ch,
  fundgold, fundgold_ch, fundother, fundother_ch, fundloan, fundloan_ch,
  funddebt, funddebt_ch, funduncome, funduncome_ch, fundunpay, fundunpay_ch,
  fundadjust, fundadjust_ch, fundintr, fundintr_ch, fundaward, fundaward_ch,
  rzlx, rzlx_ch, rcsr, rcsr_ch, lxs, lxs_ch, qtsz, qtsz_ch, bankcode,
  tjdate, remark)
select serverid, orgid, custid, fundid, moneytype, fundlastbal, fundbal, fundbal_ch,
  fundsave, fundsave_ch, fundunsave, fundunsave_ch, fundzqjy_ch, fundzqjy0_ch,
  fundbxyw, fundbxyw_ch, fundotc, fundotc_ch, fundkfjj, fundkfjj_ch,
  fundgold, fundgold_ch, fundother, fundother_ch, fundloan, fundloan_ch,
  funddebt, funddebt_ch, funduncome, funduncome_ch, fundunpay, fundunpay_ch,
  fundadjust, fundadjust_ch, fundintr, fundintr_ch, fundaward, fundaward_ch,
  rzlx, rzlx_ch, rcsr, rcsr_ch, lxs, lxs_ch, qtsz, qtsz_ch, bankcode,
  tjdate, remark
from CustHis..fundasset_hs_2016
```

















调整初始核算平衡

```sql
update stkasset_hs set stkadjust=
  stkcost + stkqty_tzje
+ (jrzc + sxf + ghf + yhs + qtfee + lxs)
- (cjsr + lxsr + syvalue)

update fundasset_hs set fundadjust=
  funduncome + fundbal + fundloan + rzlx
- (fundunpay + funddebt)
- (fundaward + rcsr + qtsz)
- (fundotc + fundbxyw + fundother + fundgold + fundsave - fundunsave)
```

#### 数据结构


| 对象名称     | 数据库对象            | 对象类型 |
|--------------|-----------------------|----------|
| 业务流水     | logasset_hs           | 输入     |
| 持仓核算     | stkasset_hs           | 输出     |
| 资金核算     | fundasset_hs          | 输出     |



| 变量名称 | 类型 | 字段        | 说明                               |
|----------|------|-------------|------------------------------------|
| 节点号   | 信息 | serverid    |                                    |
| 交收日期 | 信息 | bizdate     | 以交收日期为核算日期               |
| 交易日期 | 信息 | orderdate   |                                    |
| 委托序号 | 信息 | orderid     |                                    |
| 委托号   | 信息 | ordersno    |                                    |
| 交易序号 | 信息 | sno         | 业务流水标识 说明 2）              |
| 关联序号 | 信息 | ref_sno     |                                    |
| 关联代码 | 信息 | ref_stkcode |                                    |
| 机构号   | 信息 | orgid       |                                    |
| 客户号码 | 信息 | custid      |                                    |
| 资金账号 | 信息 | fundid      |                                    |
| 证券账号 | 信息 | secuid      |                                    |
| 货币代码 | 信息 | moneytype   | 0人民币、1港币、2美元              |
| 业务摘要 | 信息 | digestid    |                                    |
| 市场代码 | 信息 | market      | 0深A、1沪A、2深B 、3沪B            |
| 证券代号 | 信息 | stkcode     |                                    |
| 银行代号 | 信息 | bankcode    |                                    |
| 资金发生 | 信息 | fundeffect  |                                    |
| 资金余额 | 信息 | fundbal     |                                    |
| 股份发生 | 信息 | stkeffect   |                                    |
| 股份余额 | 信息 | stkbal      |                                    |
| 成交数量 | 信息 | matchqty    | 股份实际成交数量或者转托管等的数量 |
| 成交金额 | 信息 | matchamt    |                                    |
| 成交价格 | 信息 | matchprice  |                                    |
| 券商佣金 | 信息 | fee_jsxf    | 说明 1)                            |
| 手续费   | 信息 | fee_sxf     | 说明 1)                            |
| 过户费   | 信息 | fee_ghf     | 说明 3)                            |
| 印花税   | 信息 | fee_yhs     | 说明 4)                            |
| 前台费   | 信息 | feefront    | 归入"其它费"                       |
| 操作方式 | 信息 | operway     |                                    |
| 买卖类别 | 信息 | bsflag      |                                    |
| 备注     | 信息 | remark      |                                    |
| 核算状态 | 信息 | sett_status |                                    |
| 核算备注 | 信息 | sett_remark |                                    |


说明  
1. 用户付出的手续费，减去交易所费用等，才是CSC收到的净手续费。手续费不含印花税、过户费、前台费。
2. 根据节点号、交收日期、交易序号可唯一确定一条交易流水。PRIMARY KEY (serverid, bizdate, sno)
3. 过户费是指委托买卖的股票、基金成交后买卖双为变更股权登记所支付的费用。
    - 这笔收入属于证券登记清算机构的收入。
    - 由CSC在同投资者清算交割时代为扣收。
4. 印花税：只对卖出方（或继承、赠与A股、B股股权的出让方）征收证券（股票）交易印花税。
    - 对买入方(受让方)不征税。
    - 税率为 1‰。



输出表的字段分三类：
-  交易信息 :: 一般为非数值量，来自业务流水表等记录交易信息的字段。
-  会计科目 :: 能够用复式记账法进行核算的会计科目。资产 + 费用 = 负债 + 收益。
-  统计量 :: 对会计科目的进一步加工（汇总、差分等）或对交易细节的记录。

变动类字段，在每天的初始化阶段会清零。所以核算过程中只要和其对应的加总字段一致变化即可。

持仓头寸归集标准为：
  - 节点号、营业部号、客户号、市场、证券代码、流通类型。
  - 凡以上七个字段相同的操作，影响同一个证券持仓头寸。


| 变量名称         | 类型     | 字段          | 说明                                                        |
|------------------|----------|---------------|-------------------------------------------------------------|
| 节点号           | 信息     | serverid      | 节点A：1-3，B股：7，融资融券：8                             |
| 营业部号         | 信息     | orgid         | 对应业务流水相同字段                                        |
| 客户号           | 信息     | custid        | 对应业务流水相同字段                                        |
| 资金帐号         | 信息     | fundid        | 对应业务流水相同字段                                        |
| 市场             | 信息     | market        | 0深A 1沪A 2深B 3沪B J基金 5沪港通 6股转 8融资融券 G个股期权 |
| 证券代码         | 信息     | stkcode       | 对应业务流水相同字段                                        |
| 市场价格         | 信息     | stkprice      | 市场数据表的收盘价                                          |
| 流通类型         | 信息     | ltlx          | 说明 1)                                                     |
| 计提日期         | 信息     | jtdate        | 说明 2)                                                     |
| 公允日期         | 信息     | gydate        | ？                                                          |
| 备注             | 信息     | remark        | 内容不做限制                                                |
| 买入数量         | 表外贷方 | stkbuyqty     | 二级市场买卖交易，统计客户交易量用                          |
| 买入金额         | 表外贷方 | stkbuyamt     |                                                             |
| 卖出数量         | 表外借方 | stksaleqty    | 二级市场买卖交易，统计客户交易量用                          |
| 卖出金额         | 表外借方 | stksaleamt    |                                                             |
| 申购数量         | 表外贷方 | stkbuyqty_ex  | 如LOF、ETF申购、基金认购等                                  |
| 其它买入金额     | 表外贷方 | stkbuyamt_ex  | 说明 3)                                                     |
| 赎回数量         | 表外借方 | stksaleqty_ex | 如LOF、ETF赎回、基金赎回等                                  |
| 其它卖出金额     | 表外借方 | stksaleamt_ex | 说明 3)                                                     |
| 转入数量         | 表外贷方 | stkztgrqty    | 说明 4)                                                     |
| 转入金额         | 表外贷方 | stkztgramt    | 说明 4)                                                     |
| 转出数量         | 表外借方 | stkztgcqty    | 说明 4)                                                     |
| 转出金额         | 表外借方 | stkztgcamt    | 说明 4)                                                     |
| 红股数量         | 表外贷方 | stkhgqty      | 红股价格视为零                                              |
| 红利金额         | 表外贷方 | stkhlamt      |                                                             |
| 配股数量         | 表外贷方 | stkpgqty      | 视为以配股价格购入                                          |
| 配股金额         | 表外贷方 | stkpgamt      |                                                             |
| 持仓数量         | 表外借方 | stkqty        |                                                             |
| 调整数量         | 表外借方 | stkqty_tz     | 说明 9)                                                     |
| 调整金额         | 表外借方 | stkqty_tzje   | 说明 9)                                                     |
| 质押数量         | 表外借方 | stkpledge     | 说明 5)                                                     |
| 借入数量         | 表外贷方 | stkdebt       | 说明 6)   ?                                                 |
| 借出数量         | 表外借方 | stkloan       | 说明 6)                                                     |
| 毛手续费         | 表外贷方 | sxf           |                                                             |
| 持仓成本         | 表内借方 | stkcost       |                                                             |
| 外部转托金额     | 表内借方 | stkadjust     | 说明 7)                                                     |
| 交易收益         | 表内贷方 | syvalue       | 核算买卖价差损益（平均成本法）                              |
| 浮动盈亏         | 表内贷方 | gyvalue       | 等于：市值金额 - 持仓成本                                   |
| 利息收入         | 表内贷方 | lxsr          | 说明 11)                                                    |
| 借出利息收入     | 表内贷方 | cjsr          | 出借资券业务的收入                                          |
| 借入利息费用     | 表内贷方 | jrzc          | 借入资券业务的支出，含质押式融资融券                        |
| 预计利息         | 表内借方 | aiamount      | 说明 10)                                                    |
| 净手续费         | 表内借方 | jsxf          | 即券商佣金                                                  |
| 印花税费         | 表内借方 | yhs           |                                                             |
| 过户费用         | 表内借方 | ghf           |                                                             |
| 其它费用         | 表内借方 | qtfee         |                                                             |
| 利息税费         | 表内借方 | lxs           |                                                             |
| 利息成本         | 表内贷方 | aicost        | 说明 10)                                                    |
| 债券票面利息     | 统计     | bondintr      | 说明 10)                                                    |
| 利息计提         | 统计     | lxjt          | 说明 10)                                                    |
| 市值金额         | 统计     | mktvalue      | 等于 市场价格 * 持仓数量                                    | 
| 持仓数量变动     | 变动     | stkqty_ch     |                                                             |
| 持仓成本变动     | 变动     | stkcost_ch    |                                                             |
| 浮动盈亏变动     | 变动     | gyvalue_ch    |                                                             |
| 交易收益变动     | 变动     | syvalue_ch    |                                                             |
| 利息收入变动     | 变动     | lxsr_ch       |                                                             |
| 借出利息收入变动 | 变动     | cjsr_ch       |                                                             |
| 借入利息费用变动 | 变动     | jrzc_ch       |                                                             |
| 回购利息变动     | 变动     | hglx_ch       |                                                             |
| 总计费用变动     | 变动     | fee_ch        |                                                             |
| 净手续费变动     | 变动     | jsxf_ch       |                                                             |
| 印花税变动       | 变动     | yhs_ch        |                                                             |
| 过户费变动       | 变动     | ghf_ch        |                                                             |
| 利息税变动       | 变动     | lxs_ch        |                                                             |
| 其它费变动       | 变动     | qtfee_ch      |                                                             |
| 利息成本变动     | 变动     | aicost_ch     |                                                             |
| 利息计提变动     | 变动     | lxjt_ch       |                                                             |
| 毛手续费变动     | 变动     | sxf_ch        |                                                             |
| 外部转托金额变动 | 变动     | stkadjust_ch  |                                                             |


说明
1.  流通类型（ltlx）相当于证券代码的补充。包括：00流通股 02配股 01限售流通 03申购状态 04收购状态 06融资回购 07融券回购 80多仓 81空仓。
    - 正常情况下一般都是00流通股，涉及到新股申购、未上市股份、融资融券、期货期权时才不为00。
2.  计提的目的是更新市场价值（MTM）和利息积数（accrual），是每天的一次操作。
    - 在核算完成后由外部单独步骤“公允与利息处理”触发。
3.  不参与交易量统计,非交易量金额，如ETF申赎现金替代、转债转股资金、行权资金等。
4.  是指在公司内部不同资产形式的转换，区别从外部转入转出的资产。
    - 含转托管入或出、ETF申赎转入或出、转债转股入或出、合并拆分入或出、ETF认购入或出、其他转换类入或出等。
    - 转入转出价格一般指定为当日收盘价格。不影响资金发生。 
5.  质押的证券不影响成本。相当于把证券“冻结”，因此会限制可出售的证券数量。
6.  借出证券不影响成本。但会减少允许出售的份数。
7.  外部转托管金额记录非我公司资产之间的转入转出。此项引起的资产增加或减少，视同基金的申购或退出。
    - 参考价格为当日收盘价。
9.  调整数量和调整金额可正可负。用于分红到帐和除权除息不同步时校正市值。
10. 与债券利息有关各统计量的关系：
    - 预计利息是截至当天属于客户，但还未交收的利息。
    - 预计利息 = 持仓数量 * 债券票面利息 = 利息成本 + 利息计提
    - 利息成本是所有债券交易全价与净价之差部分的累积（前手息）。
    - 债券卖出时，利息成本按卖出数量与持仓数量的比例计减。
    - 利息计提是由于客户持有债券挣得的利息部分。
    - 利息计提 = 预计利息 - 利息成本
    - 债券票面利息 = 预计利息 / 持仓数量
11. 利息收入核算已经交收的股息或者债券利息。
    - 判断是股息还是债券利息，可由证券代码进行区分。
    - 卖出债券时，按照卖出利息金额-利息成本记增。（合理？）


| 变量名称         | 类型     | 字段          | 说明                                          |
|------------------|----------|---------------|-----------------------------------------------|
| 节点号           | 信息     | serverid      | 对应业务流水相同字段                          |
| 营业部号         | 信息     | orgid         | 对应业务流水相同字段                          |
| 客户号           | 信息     | custid        | 对应业务流水相同字段                          |
| 资金帐号         | 信息     | fundid        | 对应业务流水相同字段                          |
| 货币类型         | 信息     | moneytype     | 对应业务流水相同字段                          |
| 银行代码         | 信息     | bankcode      | 开户行标识                                    |
| 统计日期         | 信息     | tjdate        |                                               |
| 备注             | 信息     | remark        | 不限制内容                                    |
| 账户资金         | 表内借方 | fundbal       | 受借出、借入的金额会影响                      |
| 存款金额         | 表内贷方 | fundsave      |                                               |
| 取款金额         | 表内借方 | fundunsave    |                                               |
| 借出金额         | 表内借方 | fundloan      |                                               |
| 借入金额         | 表内贷方 | funddebt      |                                               |
| 在途未收         | 表内借方 | funduncome    | 应收账款                                      |
| 在途未付         | 表内贷方 | fundunpay     | 应付账款                                      |
| 利息积数         | 表内贷方 | fundintr      | 未发放的利息收入 说明 1)                      |
| 累计结息         | 表内贷方 | fundaward     | 已经发放的利息收入 说明 1)                    |
| 融资利息         | 表内贷方 | rzlx          |                                               |
| 账户资金变动     | 变动     | fundbal_ch    |                                               |
| 取款金额变动     | 变动     | fundunsave_ch |                                               |
| 存款金额变动     | 变动     | fundsave_ch   |                                               |
| 借出金额变动     | 变动     | fundloan_ch   |                                               |
| 借入金额变动     | 变动     | funddebt_ch   |                                               |
| 在途未收变动     | 变动     | funduncome_ch |                                               |
| 在途未付变动     | 变动     | fundunpay_ch  |                                               |
| 利息积数变动     | 变动     | fundintr_ch   |                                               |
| 累计结息变动     | 变动     | fundaward_ch  |                                               |
| 融资利息变动     | 变动     | rzlx_ch       |                                               |
| 外部资产增减变动 | 统计     | fundadjust_ch | 等于：差分 外部资产增减                       |
| 外部资产增减     | 统计     | fundadjust    | 说明 2)                                       |
| 上日余额         | 统计     | fundlastbal   |                                               |
| 净资产           | 统计     | totalvalue    | 说明 3)                                       |
| 单位净值         | 统计     | nav           | 说明 4)                                       |
| 总市值           | 统计     | mktvalue      | 等于：持仓核算表.市值金额，对所有证券代码求和 |
| 总份额           | 统计     | totalfe       | 说明 5)                                       |


#### 各种标识id的意义
- custid：标识一个客户。
- orgid：标识一个营业部。一个客户归属于一个唯一的营业部（开户营业部）。
- serverid：标识一个按地理或业务区分的节点号。一个客户可以对应多个serverid。比如节点3和融资融券节点8。
- fundid：资金账号。同一个客户可以有多个资金账号，比如主账号、辅账号等。
- secuid：证券账号。同一个客户也可用拥有多个证券账号，比如在沪市、深市都开立了证券账号。

```
graph TB
orgid --> custid
custid --> serverid_1
custid --> serverid_2
custid --> fundid_1
custid --> fundid_2
custid --> secuid_1
custid --> secuid_2

style orgid fill:lightpink
style fundid_1 fill:lightblue
style fundid_2 fill:lightblue
style secuid_1 fill:lightgreen
style secuid_2 fill:lightgreen
style serverid_1 fill:lightyellow
style serverid_2 fill:lightyellow
```



代总 

- 场外开基（完善处理逻辑）
- 股票质押（未取到在途记录、未解质数量异常）


在核算跑批阶段，若以下相关业务出现问题，需要代总协助处理：

- 场外开基
- ETF
- LOF
- 股票质押
- 融资融券
- 转融通
- 转托管
- 转股回售
- 理财代销
